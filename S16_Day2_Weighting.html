<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Camilla Salvatore">

<title>Survey weighting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="S16_Day2_Weighting_files/libs/clipboard/clipboard.min.js"></script>
<script src="S16_Day2_Weighting_files/libs/quarto-html/quarto.js"></script>
<script src="S16_Day2_Weighting_files/libs/quarto-html/popper.min.js"></script>
<script src="S16_Day2_Weighting_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="S16_Day2_Weighting_files/libs/quarto-html/anchor.min.js"></script>
<link href="S16_Day2_Weighting_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="S16_Day2_Weighting_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="S16_Day2_Weighting_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="S16_Day2_Weighting_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="S16_Day2_Weighting_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="S16_Day2_Weighting_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="S16_Day2_Weighting_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><strong>Introduction</strong></a></li>
  <li><a href="#analysing-nonresponse" id="toc-analysing-nonresponse" class="nav-link" data-scroll-target="#analysing-nonresponse"><strong>Analysing nonresponse</strong></a></li>
  <li><a href="#adjusting-for-nonresponse" id="toc-adjusting-for-nonresponse" class="nav-link" data-scroll-target="#adjusting-for-nonresponse"><strong>Adjusting for Nonresponse</strong></a>
  <ul class="collapse">
  <li><a href="#propensity-score-weighting-and-stratification" id="toc-propensity-score-weighting-and-stratification" class="nav-link" data-scroll-target="#propensity-score-weighting-and-stratification"><strong>Propensity score weighting and stratification</strong></a>
  <ul class="collapse">
  <li><a href="#weighting-creating-tailored-weights" id="toc-weighting-creating-tailored-weights" class="nav-link" data-scroll-target="#weighting-creating-tailored-weights"><strong>Weighting: Creating tailored weights</strong></a></li>
  <li><a href="#propensity-score-stratification" id="toc-propensity-score-stratification" class="nav-link" data-scroll-target="#propensity-score-stratification"><strong>Propensity score stratification</strong></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#adjusting-for-nonresponse-and-coverage" id="toc-adjusting-for-nonresponse-and-coverage" class="nav-link" data-scroll-target="#adjusting-for-nonresponse-and-coverage"><strong>Adjusting for Nonresponse and Coverage</strong></a>
  <ul class="collapse">
  <li><a href="#poststratification" id="toc-poststratification" class="nav-link" data-scroll-target="#poststratification"><strong>Poststratification</strong></a></li>
  <li><a href="#raking" id="toc-raking" class="nav-link" data-scroll-target="#raking"><strong>Raking</strong></a></li>
  <li><a href="#greg" id="toc-greg" class="nav-link" data-scroll-target="#greg"><strong>GREG</strong></a></li>
  <li><a href="#compare-the-three-methods" id="toc-compare-the-three-methods" class="nav-link" data-scroll-target="#compare-the-three-methods"><strong>Compare the three methods</strong></a></li>
  <li><a href="#extra-exercises-1" id="toc-extra-exercises-1" class="nav-link" data-scroll-target="#extra-exercises-1"><strong>Extra exercises</strong></a></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong>Survey weighting</strong></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Camilla Salvatore </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1><strong>Introduction</strong></h1>
<p>This material is part of the Utrecht <a href="https://utrechtsummerschool.nl/courses/data-science/survey-research-statistical-analysis-and-estimation">Summer School S16 - Survey Research: Statistical Analysis and Estimation</a>.</p>
<p>In this practical session we learn how to adjust for nonresponse and coverage.</p>
<p>The exercises are standalone: depending on your interest and the time you want to spend on every topic, you can skip exercises.</p>
</section>
<section id="analysing-nonresponse" class="level1">
<h1><strong>Analysing nonresponse</strong></h1>
<p>GPS is the acronym for General Population Survey. It is the made up name of a Dutch survey carried out by Statistics Netherlands. The survey data file has been anonymized to prevent statistical disclosure problems. The response/nonresponse patterns in the file are real.</p>
<p>The sample was selected by means of a stratified two-stage sample. In the first stage, municipalities were selected within regional strata with inclusion probabilities proportional to the number of inhabitants. In the second stage, an equal probability sample was drawn in each selected municipality. As a result the sample is self-weighting; all persons have the same inclusion probability. The sample size was 32,019.</p>
<p>Objective of the survey is to estimate population means for a number of target variables. Like every survey, however, there was nonresponse. Fortunately, it was possible to link the survey data file to the Social Statistical Database (SSD) of Statistics Netherlands. Therefore the values of a set of auxiliary variables have become available for both respondents and nonrespondents. This information can be used to analyse the nonresponse and to adjust for potential nonresponse bias.</p>
<p>You will find the survey data in the file gps.sav. The list of the available target variables and auxiliary variables (background variables) is given in the table below. The auxiliary variables are available for both respondents and nonrespondents. The target variables are only available for the respondents.</p>
<table class="table">
<colgroup>
<col style="width: 14%">
<col style="width: 59%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Type of Variable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Gender</td>
<td style="text-align: left;">Gender</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">MarStat</td>
<td style="text-align: left;">Marital status</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HasPC</td>
<td style="text-align: left;">Owns a pc or laptop?</td>
<td style="text-align: left;">Target</td>
</tr>
<tr class="even">
<td style="text-align: left;">OwnHouse</td>
<td style="text-align: left;">Owns a house?</td>
<td style="text-align: left;">Target</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Urban</td>
<td style="text-align: left;">Urbanization level of area of residence</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age13</td>
<td style="text-align: left;">Age in 13 categories</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Region</td>
<td style="text-align: left;">Region of the country</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">Phone</td>
<td style="text-align: left;">Listed telephone?</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HouseVal</td>
<td style="text-align: left;">Average value of house at zip code</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">HasJob</td>
<td style="text-align: left;">Has a job?</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Employed</td>
<td style="text-align: left;">Employment status in three categories</td>
<td style="text-align: left;">Target</td>
</tr>
<tr class="even">
<td style="text-align: left;">Married</td>
<td style="text-align: left;">Married?</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HHSize</td>
<td style="text-align: left;">Size of the household</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">HHType</td>
<td style="text-align: left;">Type of household</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ethnic</td>
<td style="text-align: left;">Ethnicity</td>
<td style="text-align: left;">Auxiliary</td>
</tr>
<tr class="even">
<td style="text-align: left;">Respons1</td>
<td style="text-align: left;">Response after one month?</td>
<td style="text-align: left;">Paradata</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Result</td>
<td style="text-align: left;">Fieldwork result</td>
<td style="text-align: left;">Paradata</td>
</tr>
<tr class="even">
<td style="text-align: left;">Response</td>
<td style="text-align: left;">Response after two months?</td>
<td style="text-align: left;">Paradata</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Contact</td>
<td style="text-align: left;">Contact with sample unit?</td>
<td style="text-align: left;">Paradata</td>
</tr>
<tr class="even">
<td style="text-align: left;">Able</td>
<td style="text-align: left;">Sample unit able to respond?</td>
<td style="text-align: left;">Paradata</td>
</tr>
</tbody>
</table>
<p>To load the data into R, we can use the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>gps <span class="ot">&lt;-</span> <span class="fu">read.spss</span>(<span class="st">"gps.sav"</span>, <span class="at">to.data.frame =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><strong>Compute the Response Rate</strong></li>
</ol>
<p>Calculate the response rate for the survey. Use the variable <code>Result</code> for this. The variable <code>Result</code> contains the percentage of people that fall in each response category: 1) “Unproc” = case is not handled by the interviewer and returned unprocessed, 2) “Response” = case responds, 3) “Non-contact” = no contact was established with case during data collection period, 4) “Refusal” = case refused participation, and 5) “Not-able” = case was not able to respond due to language or physical/mental condition.</p>
<p><strong>Hint</strong>: use <code>prop.table.</code></p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(gps<span class="sc">$</span>Result))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     Unproc    Response Non-contact     Refusal    Not-able 
 0.07670446  0.58690153  0.05768450  0.24641619  0.03229333 </code></pre>
</div>
</div>
<p>The resulting response rate is RR1 in AAPOR definition. From the table, we can observe that the response rate is around 58.7%.</p>
</div>
</div>
</div>
<ol start="2" type="1">
<li><strong>Identify the variables that associate most with nonresponse</strong></li>
</ol>
<p>As the response rate is well below 100%, there is a risk of nonresponse bias. Nonresponse adjustment may be necessary. Before we can do such an adjustment, we first need to investigate the relationships between auxiliary variables and response, and between the auxiliary variables and the target variables of the survey. For this purpose, we employ so-called association measures. The correlation between two variables is the most well-known but cannot be applied to categorical variables. For categorical variables other measures exist such as Cramér’s V. These measures usually take values between 0 and 1, where 0 indicates no association and 1 means full association.</p>
<ul>
<li>Build contingency tables of the response indicator versus each of the auxiliary variables. Perform chi-square tests for independence of response and each of the auxiliary variables. You can use <code>chisq.test(response,variable)</code>.</li>
</ul>
<p>What are the strongest candidates for nonresponse adjustment?</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable gender</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Gender)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>gendertest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Gender)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>gendertest</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable marstat</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>MarStat)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>martest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>MarStat)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>martest</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable urban</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Urban)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>urbantest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Urban)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>urbantest</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable age13</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Age13)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>age13test <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Age13)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>age13test</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable region</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Region)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>regiontest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Region)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>regiontest</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable phone</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Phone)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>phonetest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Phone)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>phonetest</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable houseval</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HouseVal)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>housetest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HouseVal)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>housetest</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable hasjob</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HasJob)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>jobtest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HasJob)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>jobtest</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable married</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Married)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>marriedtest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Married)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>marriedtest</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable hhsize</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HHSize)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>hhstest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HHSize)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>hhstest</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable hhtype</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HHType)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>hhttest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>HHType)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>hhttest</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co"># for auxiliary variable ethnic</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Ethnic)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>ethnictest <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(gps<span class="sc">$</span>Response, gps<span class="sc">$</span>Ethnic)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>ethnictest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An overview of all the obtained chi-square values with accompanying p-values can be found in the table below:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Chi-square</th>
<th style="text-align: left;">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: left;">852</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">Urban</td>
<td style="text-align: left;">747</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">phone</td>
<td style="text-align: left;">716</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">houseval</td>
<td style="text-align: left;">427</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ethnic</td>
<td style="text-align: left;">402</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">hhtype</td>
<td style="text-align: left;">358</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hhsize</td>
<td style="text-align: left;">315</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">Marstat</td>
<td style="text-align: left;">302</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">married</td>
<td style="text-align: left;">298</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age13</td>
<td style="text-align: left;">119</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hasjob</td>
<td style="text-align: left;">45</td>
<td style="text-align: left;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">gender</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">0.04</td>
</tr>
</tbody>
</table>
<p>The p-values of all chi-square test are 0.0 except for gender. However, even for gender it is below 0.05. So, on the basis of these values all variables are candidates.</p>
</div>
</div>
</div>
<p>However, in large datasets, the chi-square test does not discriminate enough between the different variables. Therefore, we also look at the Cramér’s V.</p>
<ul>
<li>Compute the Cramér’s V: What variables associate most with response?</li>
</ul>
<p>This association measure takes into account the different degrees of freedom of the variables (due to different number of categories) and the dimension of the dataset.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Cramér’s V
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>V = 0 indicates that the selected variable and the response indicator are completely independent</p></li>
<li><p>V = 1 indicates the selected variable and the response indicator are completely dependent</p></li>
</ul>
</div>
</div>
<p>The variables can thus be sorted according to the value of Cramér’s V and the strongest candidates can be selected. To calculate Cramér’s V in R, we can use the <code>cramersv()</code> function. This function has to be applied to a <code>chisq.test()</code> object, that we have created before.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(confintr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'confintr' was built under R version 4.3.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(regiontest)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(urbantest)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(phonetest)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(housetest)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(ethnictest)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(hhttest)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(hhstest)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(martest)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(marriedtest)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(age13test)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(jobtest)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cramersv</span>(gendertest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can extend the table with the chi-square values, with the Cramér’s V values:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Chi-square</th>
<th style="text-align: left;">p-value</th>
<th style="text-align: left;">Cramér’s V</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: left;">852</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.16</td>
</tr>
<tr class="even">
<td style="text-align: left;">Urban</td>
<td style="text-align: left;">747</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">phone</td>
<td style="text-align: left;">716</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.15</td>
</tr>
<tr class="even">
<td style="text-align: left;">houseval</td>
<td style="text-align: left;">427</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ethnic</td>
<td style="text-align: left;">402</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.11</td>
</tr>
<tr class="even">
<td style="text-align: left;">hhtype</td>
<td style="text-align: left;">358</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.11</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hhsize</td>
<td style="text-align: left;">315</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Marstat</td>
<td style="text-align: left;">302</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">married</td>
<td style="text-align: left;">298</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Age13</td>
<td style="text-align: left;">119</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hasjob</td>
<td style="text-align: left;">45</td>
<td style="text-align: left;">0.00</td>
<td style="text-align: left;">0.04</td>
</tr>
<tr class="even">
<td style="text-align: left;">gender</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">0.04</td>
<td style="text-align: left;">0.01</td>
</tr>
</tbody>
</table>
<p>The strongest candidates for nonresponse adjustment based on the relationship with the response indicator are those variables that have the highest value for Cramér’s V. If we restrict ourselves to four variables then these are <em>Region</em>, <em>Urban</em>, <em>Phone</em> and <em>HouseVal</em>. However, since these variables must be expected to be related, a multivariate analysis is needed.</p>
</div>
</div>
</div>
<ol start="3" type="1">
<li><strong>Compute the R-indicator using the variables identified in the previous point</strong></li>
</ol>
<p>The response rate is just one indicator of the quality of the response. We also need to look at the composition of the response. For this purpose we compute the R-indicator.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
R-indicator
</div>
</div>
<div class="callout-body-container callout-body">
<p>The R-indicator can be calculated using the following expression:</p>
<p><span class="math display">\[R(X) = 1 - 2 S(\rho (X))\]</span> With <span class="math inline">\(S(\rho(X))\)</span></p>
<p>representing the standard deviation of the estimated response probabilities.</p>
</div>
</div>
<ul>
<li>Use the full sample (stored in object gps). First, you need to estimate the individual response probabilities. Include the auxiliary variables <code>Region</code>, <code>Urban</code>, <code>Phone</code>, <code>HouseVal</code>, <code>Ethnic</code> and <code>HHType</code>. These are the six variables with the highest Cramér’s V value. Because the response indicator is a binary variable (either 0 or 1), we use a binary logistic regression model. The response indicator (<code>Response</code>) is the dependent variable, and the six auxiliary variables are entered in the model as explanatory variables.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>prob <span class="ot">&lt;-</span> <span class="fu">glm</span>(Response <span class="sc">~</span> Region <span class="sc">+</span> Urban <span class="sc">+</span> Phone <span class="sc">+</span> HouseVal <span class="sc">+</span> Ethnic <span class="sc">+</span> HHType, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> gps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Add the estimated response probabilities to the data file by getting the predicted values from the object that was just created. To obtain this, we use the <code>predict()</code> function:</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gps<span class="sc">$</span>resp_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(prob, gps, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Compute standard deviation of the estimated response probabilities. Use <code>sd(response probabilities)</code></li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sd_p <span class="ot">&lt;-</span> <span class="fu">sd</span>(gps<span class="sc">$</span>resp_prob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Compute the R-indicator.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>sd_p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7780618</code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li>This is actually the R-indicator computed using the data after 2 months of data collection. Repeat the analysis using the data after 1 month of data collection (<code>Response1</code>). What are your conclusions?</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>prob1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(Respons1 <span class="sc">~</span> Region <span class="sc">+</span> Urban <span class="sc">+</span> Phone <span class="sc">+</span> HouseVal <span class="sc">+</span> Ethnic <span class="sc">+</span> HHType, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> gps)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>gps<span class="sc">$</span>resp_prob1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(prob1, gps, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>sd_p1 <span class="ot">&lt;-</span> <span class="fu">sd</span>(gps<span class="sc">$</span>resp_prob1)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>sd_p1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8115925</code></pre>
</div>
</div>
<p>The response is representative if the individual response propensities are equal for all units of the population. We see that the R-indicator is slightly higher after one month of data collection, when compared to the R-indicator after two months of data collection. This means that the response does not become more representative (representativeness decreases a little bit even) after an extra month of data collection. There seems little reason to perform the second month of data collection.</p>
</div>
</div>
</div>
</section>
<section id="adjusting-for-nonresponse" class="level1">
<h1><strong>Adjusting for Nonresponse</strong></h1>
<section id="propensity-score-weighting-and-stratification" class="level2">
<h2 class="anchored" data-anchor-id="propensity-score-weighting-and-stratification"><strong>Propensity score weighting and stratification</strong></h2>
<section id="weighting-creating-tailored-weights" class="level3">
<h3 class="anchored" data-anchor-id="weighting-creating-tailored-weights"><strong>Weighting: Creating tailored weights</strong></h3>
<p>In this exercise we are going to create tailored weights for a survey dataset. We will use the NHANES dataset, which is a survey dataset from the National Health and Nutrition Examination Survey.</p>
<p>This example is adapted from the course <a href="https://www.understandingsociety.ac.uk/help/training/creating-tailored-weights/">Creating Tailored Weights</a> held by Understanding Society. You can find their implementation in Stata <a href="https://www.youtube.com/watch?v=6C-l4QoF--A&amp;ab_channel=UnderstandingSociety%3AUKHLS">Here</a>. Here we replicate this example in R.</p>
<p>The variables that define the sampling design characteristics are:</p>
<ul>
<li><code>sampl</code>: an ID variable</li>
<li><code>stratid</code>: a stratification variable</li>
<li><code>location</code>: a clustering variable</li>
<li><code>finalwgt</code>: a design weight</li>
</ul>
<p>The specific task is now, to create a tailored weight for the variable <code>hdresult</code>, which contains serum levels of high-density lipoproteins (HDL). However, only 8708 out of 10,337 entries are valid. We will adjust for this missingness through a tailored weight. We assume that all people are eligible to have a valid value for <code>hdresult</code> and that those who don’t have the value are nonrespondents. To create these tailored weights, we will draw upon the base weight <code>finalwgt</code> and create a weight adjustment.</p>
<p>We will use the following packages</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>1. Loading the NHANES dataset</strong></p>
<ul>
<li>First, load the NHANES dataset into R. The dataset is available through <a href="https://www.stata-press.com/data/r16/nhanes2f.dta">this</a> link in the dta format and can be loaded using the <code>haven</code> package. Then, familiarize yourself with the dataset.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the NHANES II dataset</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"https://www.stata-press.com/data/r16/nhanes2f.dta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>2. Create a 0/1 indicator of response</strong></p>
<p>To create a 0/1 indicator of response, where 0 is for nonrespondents and 1 is for respondents, use the <code>hdresult</code> variable. For simplicity treat missing values as non response.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 0/1 indicator of response</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> nhanes2 <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resp =</span> <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(hdresult), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># if hdresult is not missing, set resp to 1, otherwise 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p><strong>3. Predict the response using logistic regression</strong></p>
<ul>
<li>Select suitable predictors for the logistic regression model. Ensure that the predictors do not have missing values. If they do, impute them with a simple procedure, such as taking their average category or mean.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the summary of the predictors and check if they contain missing values</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhanes2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(sex, race, age, weight,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                           bpsystol, region, health,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                           heartatk, diabetes, sizplace))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      sex             race            age            weight      
 Min.   :1.000   Min.   :1.000   Min.   :20.00   Min.   : 30.84  
 1st Qu.:1.000   1st Qu.:1.000   1st Qu.:31.00   1st Qu.: 60.67  
 Median :2.000   Median :1.000   Median :49.00   Median : 70.42  
 Mean   :1.525   Mean   :1.144   Mean   :47.56   Mean   : 71.90  
 3rd Qu.:2.000   3rd Qu.:1.000   3rd Qu.:63.00   3rd Qu.: 81.19  
 Max.   :2.000   Max.   :3.000   Max.   :74.00   Max.   :175.88  
                                                                 
    bpsystol         region          health         heartatk      
 Min.   : 65.0   Min.   :1.000   Min.   :1.000   Min.   :0.00000  
 1st Qu.:114.0   1st Qu.:2.000   1st Qu.:3.000   1st Qu.:0.00000  
 Median :128.0   Median :3.000   Median :3.000   Median :0.00000  
 Mean   :130.9   Mean   :2.582   Mean   :3.414   Mean   :0.04577  
 3rd Qu.:142.0   3rd Qu.:4.000   3rd Qu.:4.000   3rd Qu.:0.00000  
 Max.   :300.0   Max.   :4.000   Max.   :5.000   Max.   :1.00000  
                                 NA's   :2       NA's   :2        
    diabetes          sizplace    
 Min.   :0.00000   Min.   :1.000  
 1st Qu.:0.00000   1st Qu.:3.000  
 Median :0.00000   Median :5.000  
 Mean   :0.04828   Mean   :5.166  
 3rd Qu.:0.00000   3rd Qu.:8.000  
 Max.   :1.00000   Max.   :8.000  
 NA's   :2                        </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Checking predictors and imputing missing values</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> nhanes2 <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">health =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(health), <span class="dv">3</span>, health), <span class="co"># impute missing values with 3</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">heartatk =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(heartatk), <span class="dv">0</span>, heartatk), <span class="co"># impute missing values with 0</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">diabetes =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(diabetes), <span class="dv">0</span>, diabetes) <span class="co"># impute missing values with 0</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the summary of the predictors again to confirm no missing values</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhanes2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(sex, race, age, weight, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                           bpsystol, region, health, </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                           heartatk, diabetes, sizplace))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      sex             race            age            weight      
 Min.   :1.000   Min.   :1.000   Min.   :20.00   Min.   : 30.84  
 1st Qu.:1.000   1st Qu.:1.000   1st Qu.:31.00   1st Qu.: 60.67  
 Median :2.000   Median :1.000   Median :49.00   Median : 70.42  
 Mean   :1.525   Mean   :1.144   Mean   :47.56   Mean   : 71.90  
 3rd Qu.:2.000   3rd Qu.:1.000   3rd Qu.:63.00   3rd Qu.: 81.19  
 Max.   :2.000   Max.   :3.000   Max.   :74.00   Max.   :175.88  
    bpsystol         region          health         heartatk      
 Min.   : 65.0   Min.   :1.000   Min.   :1.000   Min.   :0.00000  
 1st Qu.:114.0   1st Qu.:2.000   1st Qu.:3.000   1st Qu.:0.00000  
 Median :128.0   Median :3.000   Median :3.000   Median :0.00000  
 Mean   :130.9   Mean   :2.582   Mean   :3.414   Mean   :0.04576  
 3rd Qu.:142.0   3rd Qu.:4.000   3rd Qu.:4.000   3rd Qu.:0.00000  
 Max.   :300.0   Max.   :4.000   Max.   :5.000   Max.   :1.00000  
    diabetes          sizplace    
 Min.   :0.00000   Min.   :1.000  
 1st Qu.:0.00000   1st Qu.:3.000  
 Median :0.00000   Median :5.000  
 Mean   :0.04827   Mean   :5.166  
 3rd Qu.:0.00000   3rd Qu.:8.000  
 Max.   :1.00000   Max.   :8.000  </code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li>Using the variables you identified run a logistic regression model</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Logistic regression to predict response</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(resp <span class="sc">~</span> <span class="fu">factor</span>(sex) <span class="sc">+</span> <span class="fu">factor</span>(race) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>               age <span class="sc">+</span> weight <span class="sc">+</span> <span class="fu">factor</span>(region) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">factor</span>(diabetes) <span class="sc">+</span> <span class="fu">factor</span>(sizplace), <span class="co"># predictors</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> nhanes2, <span class="co"># dataset</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">family =</span> <span class="fu">binomial</span>()) <span class="co"># binomial family for logistic regression</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the summary of the model</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = resp ~ factor(sex) + factor(race) + age + weight + 
    factor(region) + factor(diabetes) + factor(sizplace), family = binomial(), 
    data = nhanes2)

Coefficients:
                   Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)        3.038391   0.203450  14.934  &lt; 2e-16 ***
factor(sex)2       0.133171   0.059871   2.224 0.026129 *  
factor(race)2      0.233674   0.092552   2.525 0.011577 *  
factor(race)3     -0.382336   0.183499  -2.084 0.037197 *  
age               -0.008039   0.001684  -4.774 1.81e-06 ***
weight            -0.008089   0.001926  -4.201 2.66e-05 ***
factor(region)2   -0.200494   0.094796  -2.115 0.034428 *  
factor(region)3   -0.928439   0.091653 -10.130  &lt; 2e-16 ***
factor(region)4   -0.397968   0.093853  -4.240 2.23e-05 ***
factor(diabetes)1 -0.517688   0.113408  -4.565 5.00e-06 ***
factor(sizplace)2 -0.960051   0.113417  -8.465  &lt; 2e-16 ***
factor(sizplace)3 -0.152250   0.120993  -1.258 0.208268    
factor(sizplace)4  0.266558   0.139023   1.917 0.055192 .  
factor(sizplace)5  0.454941   0.175049   2.599 0.009351 ** 
factor(sizplace)6 -0.385489   0.145213  -2.655 0.007939 ** 
factor(sizplace)7  0.693591   0.155897   4.449 8.63e-06 ***
factor(sizplace)8  0.379206   0.110780   3.423 0.000619 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 9006.6  on 10336  degrees of freedom
Residual deviance: 8425.9  on 10320  degrees of freedom
AIC: 8459.9

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
</div>
</div>
</div>
<ul>
<li>Predict the response probabilities for the respondents</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict response probabilities for respondents</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> nhanes2 <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prob1 =</span> <span class="fu">ifelse</span>(resp <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">predict</span>(model, <span class="at">type =</span> <span class="st">"response"</span>), <span class="dv">0</span>))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># predict response probability for respondents, set 0 for nonrespondents</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p><strong>4. Create tailored weights</strong></p>
<ul>
<li>Create a weight variable <code>cwgt</code> that is the inverse of the predicted response probability for respondents.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjustment for the wave 1 base weight</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> nhanes2 <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cwgt =</span> <span class="fu">ifelse</span>(prob1 <span class="sc">!=</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>prob1, <span class="dv">0</span>)) </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># if prob1 is not 0, set cwgt to 1/prob1, otherwise 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Create the tailored weight <code>newweight</code> by multiplying the base weight <code>finalwgt</code> with the weight adjustment <code>cwgt</code>. Display the summary of the new weight.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the tailored weight</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>nhanes2 <span class="ot">&lt;-</span> nhanes2 <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">newweight =</span> finalwgt <span class="sc">*</span> cwgt) </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create the tailored weight by multiplying finalwgt with cwgt</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary of the new weight</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nhanes2<span class="sc">$</span>newweight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
      0    4437    9626   11303   15878   94397 </code></pre>
</div>
</div>
</div>
</div>
</div>
<p><strong>5. Compare the old and new weights</strong></p>
<ul>
<li>Create the survey design objects for the old and new weights.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Old weight survey design</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>design_old <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id =</span> <span class="sc">~</span>location, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata =</span> <span class="sc">~</span>stratid, </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="sc">~</span>finalwgt, </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> nhanes2)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># New weight survey design</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>design_new <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id =</span> <span class="sc">~</span>location, </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">strata =</span> <span class="sc">~</span>stratid, </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">weights =</span> <span class="sc">~</span>newweight, </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> nhanes2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>What are the mean estimates of <code>hdresult</code> using the old and new weights?</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean estimate of hdresult using old weight</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>mean_hdresult_old <span class="ot">&lt;-</span> <span class="fu">svymean</span>(<span class="sc">~</span>hdresult, <span class="at">design =</span> design_old, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean estimate of hdresult using new weight</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>mean_hdresult_new <span class="ot">&lt;-</span> <span class="fu">svymean</span>(<span class="sc">~</span>hdresult, <span class="at">design =</span> design_new, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="propensity-score-stratification" class="level3">
<h3 class="anchored" data-anchor-id="propensity-score-stratification"><strong>Propensity score stratification</strong></h3>
<p>In this exercise you will analyse data from the data from the 2003 National Health Interview Survey (NHIS) used to monitor health conditions in the US. A smaller version of the original dataset is available the <code>PracTools</code> package. It is named named <code>nhis</code> and it includes demographic variables only.</p>
<ul>
<li><code>ID</code>: Identification variable</li>
<li><code>stratum</code>: Sample design stratum</li>
<li><code>psu</code>: Primary sampling unit</li>
<li><code>svywt</code>: Survey weight</li>
<li><code>sex</code>: Gender (1 = male; 2 = female)</li>
<li><code>age</code>: Age (continuous)</li>
<li><code>age_r</code>: Recoded age (3 = 18-24 years; 4 = 25-44 years; 5 = 45-64 years; 6 = 65-69 years; 7 = 70-74 years; 8 = 75 years and older)</li>
<li><code>hisp</code>: Hispanic ethnicity (1 = Hispanic; 2 = Non-Hispanic)</li>
<li><code>marital</code>: Marital status (1 = Separated; 2 = Divorced; 3 = Married; 4 = Single/never married; 5 = Widowed; 9 = Unknown marital status)</li>
<li><code>parents</code>: Parent(s) of sample person present in the family (1 = Mother, no father; 2 = Father, no mother; 3 = Mother and father; 4 = Neither mother nor father)</li>
<li><code>parents_r</code>: Parent(s) of sample person present in the family recode (1 = Yes; 2 = No)</li>
<li><code>educ</code>: Education (1 = 8th grade or less; 2 = 9-12th grade, no high school diploma; 3 = High school graduate; 4 = General education development (GED) degree recipient; 5 = Some college, no degree; 6 = Associate’s degree, technical or vocational; 7 = Associate’s degree, academic program; 8 = Bachelor’s degree (BA, BS, AB, BBA); 9 = Master’s, professional, or doctoral degree)</li>
<li><code>educ_r</code>: Education recode (1 = High school, general education development degree (GED), or less; 2 = Some college; 3 = Bachelor’s or associate’s degree; 4 = Master’s degree &amp; higher)</li>
<li><code>race</code>: Race (1 = White; 2 = Black; 3 = Other)</li>
<li><code>resp</code>: Respondent (0 = nonrespondent; 1 = respondent)</li>
</ul>
<ol type="1">
<li><strong>Load the package using the following code</strong></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PracTools)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"nhis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><strong>Fit unweighted logistic, probit and c-log-log models to the</strong> <code>resp</code> <strong>variable</strong></li>
</ol>
<ul>
<li>Use the covariates <code>age</code>, <code>sex</code>, <code>hisp</code> and <code>race</code></li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>logit<span class="ot">=</span><span class="fu">glm</span> (resp <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp) <span class="sc">+</span> <span class="fu">as.factor</span>(race),</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">data=</span>nhis)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>probit<span class="ot">=</span><span class="fu">glm</span> (resp <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp) <span class="sc">+</span> <span class="fu">as.factor</span>(race),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">data=</span>nhis)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>cloglog<span class="ot">=</span><span class="fu">glm</span> (resp <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp) <span class="sc">+</span> <span class="fu">as.factor</span>(race),</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"cloglog"</span>),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">data=</span>nhis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Which variables are significant predictors in each of the models?</li>
</ul>
<p>Look at the regression tables.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We can look at the following table:</p>
<div class="cell" data-align="center">

<table style="text-align:center">
<tbody><tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td colspan="3">
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="3" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td colspan="3">
resp
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>logistic</em>
</td>
<td>
<em>probit</em>
</td>
<td>
<em>glm: binomial</em>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em></em>
</td>
<td>
<em></em>
</td>
<td>
<em>link = cloglog</em>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1)
</td>
<td>
(2)
</td>
<td>
(3)
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
age
</td>
<td>
-0.010<sup>***</sup>
</td>
<td>
-0.006<sup>***</sup>
</td>
<td>
-0.006<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.002)
</td>
<td>
(0.001)
</td>
<td>
(0.001)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
as.factor(sex)2
</td>
<td>
-0.077
</td>
<td>
-0.046
</td>
<td>
-0.044
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.070)
</td>
<td>
(0.042)
</td>
<td>
(0.041)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
as.factor(hisp)2
</td>
<td>
0.405<sup>***</sup>
</td>
<td>
0.246<sup>***</sup>
</td>
<td>
0.241<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.088)
</td>
<td>
(0.054)
</td>
<td>
(0.054)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
as.factor(race)2
</td>
<td>
-0.212<sup>**</sup>
</td>
<td>
-0.128<sup>**</sup>
</td>
<td>
-0.124<sup>**</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.098)
</td>
<td>
(0.060)
</td>
<td>
(0.059)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
as.factor(race)3
</td>
<td>
-0.352<sup>**</sup>
</td>
<td>
-0.216<sup>**</sup>
</td>
<td>
-0.220<sup>**</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.160)
</td>
<td>
(0.098)
</td>
<td>
(0.100)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
1.015<sup>***</sup>
</td>
<td>
0.622<sup>***</sup>
</td>
<td>
0.272<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.114)
</td>
<td>
(0.069)
</td>
<td>
(0.068)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
3,911
</td>
<td>
3,911
</td>
<td>
3,911
</td>
</tr>
<tr>
<td style="text-align:left">
Log Likelihood
</td>
<td>
-2,400.759
</td>
<td>
-2,400.822
</td>
<td>
-2,400.990
</td>
</tr>
<tr>
<td style="text-align:left">
Akaike Inf. Crit.
</td>
<td>
4,813.519
</td>
<td>
4,813.644
</td>
<td>
4,813.980
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td colspan="3" style="text-align:right">
<sup><em></em></sup><em>p&lt;0.1; <sup><strong></strong></sup><strong>p&lt;0.05; <sup></sup></strong></em>p&lt;0.01
</td>
</tr>

</tbody></table>
</div>
<p>All variables (including the intercept) are significant in all models, except for <code>sex</code>.</p>
</div>
</div>
</div>
<ul>
<li>Compare the predicted probabilities from the three models. You can make a table or a plot. Predicted probabilities are in <code>$fitted.values</code></li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>pred.logit<span class="ot">=</span>logit<span class="sc">$</span>fitted.values</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>pred.probit<span class="ot">=</span>probit<span class="sc">$</span>fitted.values</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>pred.cloglog<span class="ot">=</span>cloglog<span class="sc">$</span>fitted.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can compare each predicted probabilities against the other:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#This is in base R but you can use ggplot2</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred.logit,pred.probit,<span class="at">xlim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>))</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred.logit,pred.cloglog,<span class="at">xlim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pred.probit,pred.cloglog,<span class="at">xlim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">0.4</span>,<span class="fl">0.8</span>))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="at">col=</span><span class="st">"blue"</span>,<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="S16_Day2_Weighting_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can make a summary table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pred.logit) <span class="sc">%&gt;%</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">summary</span>(pred.probit)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">summary</span>(pred.cloglog)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">model=</span><span class="fu">c</span>(<span class="st">"logit"</span>,<span class="st">"probit"</span>,<span class="st">"cloglog"</span>),<span class="at">.before=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> model </th>
   <th style="text-align:right;"> Min. </th>
   <th style="text-align:right;"> 1st Qu. </th>
   <th style="text-align:right;"> Median </th>
   <th style="text-align:right;"> Mean </th>
   <th style="text-align:right;"> 3rd Qu. </th>
   <th style="text-align:right;"> Max. </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> logit </td>
   <td style="text-align:right;"> 0.4769137 </td>
   <td style="text-align:right;"> 0.6585878 </td>
   <td style="text-align:right;"> 0.6924415 </td>
   <td style="text-align:right;"> 0.6901048 </td>
   <td style="text-align:right;"> 0.7260404 </td>
   <td style="text-align:right;"> 0.7765047 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> probit </td>
   <td style="text-align:right;"> 0.4808753 </td>
   <td style="text-align:right;"> 0.6584612 </td>
   <td style="text-align:right;"> 0.6919716 </td>
   <td style="text-align:right;"> 0.6900877 </td>
   <td style="text-align:right;"> 0.7258562 </td>
   <td style="text-align:right;"> 0.7773489 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> cloglog </td>
   <td style="text-align:right;"> 0.4951173 </td>
   <td style="text-align:right;"> 0.6585117 </td>
   <td style="text-align:right;"> 0.6917511 </td>
   <td style="text-align:right;"> 0.6900942 </td>
   <td style="text-align:right;"> 0.7255815 </td>
   <td style="text-align:right;"> 0.7791557 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>And some boxplots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(pred.logit,pred.probit,pred.cloglog,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"Boxplot of predicted probabilities"</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="at">xlab=</span><span class="st">"Model"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="at">ylab=</span><span class="st">"Pred. Prob."</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="at">col=</span><span class="st">"dodgerblue"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="at">border=</span><span class="st">"black"</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>,<span class="at">at=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>),<span class="at">labels=</span><span class="fu">c</span>(<span class="st">"logit"</span>,<span class="st">"probit"</span>,<span class="st">"cloglog"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="S16_Day2_Weighting_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The three models produce very similar results. The logit and probit models are almost identical, while the cloglog model shows slight differences, particularly at the extreme low end of the predicted probabilities (as seen in the scatter plots and box plots). Analyzing the min-max values and quartiles leads to the same conclusion: the models are closely aligned overall.</p>
</div>
</div>
</div>
<ol start="3" type="1">
<li><strong>Use the predicted response probabilities from the logistic regression that used all covariates and create two versions of propensity classes:</strong></li>
</ol>
<ul>
<li>Five classes with an equal number of respondents plus nonrespondents in each. Use <code>pclass</code> in order to make classes.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>p.class5 <span class="ot">&lt;-</span> <span class="fu">pclass</span>(<span class="at">formula=</span>resp <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp) <span class="sc">+</span> <span class="fu">as.factor</span>(race),</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">type=</span><span class="st">"unwtd"</span>,<span class="at">data=</span>nhis,<span class="at">link=</span><span class="st">"logit"</span>, <span class="at">numcl=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ul>
<li>Ten classes. Report the breaks used for the five and ten classes and the number of cases assigned to each class. (Check to see that all cases were assigned a non-missing class value. Use the parameter `useNA=“always”` in table in order to see whether NAs were created.)</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p.class10 <span class="ot">&lt;-</span> <span class="fu">pclass</span>(<span class="at">formula=</span>resp <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">as.factor</span>(sex) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp) <span class="sc">+</span> <span class="fu">as.factor</span>(race),</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">type=</span><span class="st">"unwtd"</span>,<span class="at">data=</span>nhis,<span class="at">link=</span><span class="st">"logit"</span>, <span class="at">numcl=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="4" type="1">
<li><strong>How do the five and ten classes compare to each other?</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-24-contents" aria-controls="callout-24" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-24" class="callout-24-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(p.class5<span class="sc">$</span>p.class,<span class="at">useNA=</span><span class="st">"always"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Boundaries"</span>,<span class="st">"Count of persons"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Boundaries </th>
   <th style="text-align:right;"> Count of persons </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> [0.477,0.651] </td>
   <td style="text-align:right;"> 783 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.651,0.68] </td>
   <td style="text-align:right;"> 782 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.68,0.706] </td>
   <td style="text-align:right;"> 782 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.706,0.734] </td>
   <td style="text-align:right;"> 782 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.734,0.777] </td>
   <td style="text-align:right;"> 782 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
</tbody>
</table>

</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(p.class10<span class="sc">$</span>p.class,<span class="at">useNA=</span><span class="st">"always"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Boundaries"</span>,<span class="st">"Count of persons"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">latex_options =</span> <span class="st">"HOLD_position"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> Boundaries </th>
   <th style="text-align:right;"> Count of persons </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> [0.477,0.629] </td>
   <td style="text-align:right;"> 392 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.629,0.651] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.651,0.665] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.665,0.68] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.68,0.692] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.692,0.706] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.706,0.72] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.72,0.734] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.734,0.75] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.75,0.777] </td>
   <td style="text-align:right;"> 391 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> NA </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>All cases have been assigned a non-missing class value, and the number of individuals is nearly as expected. The 10 classes also show greater homogeneity.</p>
</div>
</div>
</div>
<ol start="5" type="1">
<li><strong>How do the class adjustments compare to using the inverses of individual propensity estimates as adjustments?</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-25-contents" aria-controls="callout-25" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-25" class="callout-25-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>data5<span class="ot">=</span><span class="fu">data.frame</span>(p.class5)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data5, <span class="fu">aes</span>(<span class="at">x=</span>p.class, <span class="at">y=</span>propensities)) <span class="sc">+</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.y=</span>mean, <span class="at">geom=</span><span class="st">"point"</span>, <span class="at">shape=</span><span class="dv">20</span>, <span class="at">size=</span><span class="dv">4</span>, <span class="at">color=</span><span class="st">"red"</span>, <span class="at">fill=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette=</span><span class="st">"Set1"</span>)<span class="sc">+</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `fun.y` argument of `stat_summary()` is deprecated as of ggplot2 3.3.0.
ℹ Please use the `fun` argument instead.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="S16_Day2_Weighting_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>data10<span class="ot">=</span><span class="fu">data.frame</span>(p.class10)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data10, <span class="fu">aes</span>(<span class="at">x=</span>p.class, <span class="at">y=</span>propensities)) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun.y=</span>mean, <span class="at">geom=</span><span class="st">"point"</span>, <span class="at">shape=</span><span class="dv">20</span>, <span class="at">size=</span><span class="dv">4</span>, <span class="at">color=</span><span class="st">"red"</span>, <span class="at">fill=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette=</span><span class="st">"Set1"</span>)<span class="sc">+</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="S16_Day2_Weighting_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The box plots show that the first class (in both cases) is the most variable. After that, the range of propensities decreases. Using the mean (red) or the median helps to smooth out more extreme adjustments, which is especially beneficial for the first class. This highlights the advantage of using classes instead of raw propensity values.</p>
</div>
</div>
</div>
<ol start="6" type="1">
<li><strong>Which set of adjustment values would you recommend and why?</strong></li>
</ol>
<p>Think about it and discuss it in groups.</p>
<section id="extra-exercises" class="level4">
<h4 class="anchored" data-anchor-id="extra-exercises"><strong>Extra exercises</strong></h4>
<p>If the ranges of estimated propensities in each class is small, you can use a single propensity value for each class. There are several options:</p>
<p><strong>Calculate the five alternative values of NR weight adjustment shown in the box below.</strong></p>
<p>For the weighted adjustments, use the <code>svywt</code> variable. Discuss how the five alternative values of adjustments compare within the two models with five and ten classes compare to each other</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Five ways of estimating the class response propensity
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p><strong>Unweighted average</strong>: <span class="math inline">\(\hat{\phi}_c = \frac{1}{n_c} \sum_{i \in s_c} \hat{\phi}(x_i)\)</span> where <span class="math inline">\(n_c\)</span> is the unweighted number of cases in class c</p></li>
<li><p><strong>Weighted average</strong>: $<em>c =</em> d_i(x_i) / _{i s_c}d_i $ where <span class="math inline">\(d_i\)</span> is the base weight and the sum of <span class="math inline">\(d_i\)</span> is the estimated number of population units in class <span class="math inline">\(c\)</span></p></li>
<li><p><strong>Unweighted response rate</strong>: <span class="math inline">\(\hat{\phi}_c = n_{cR}/n_c\)</span> where <span class="math inline">\(n_{cR}\)</span> is the unweighted number of respondents in class c</p></li>
<li><p><strong>Weighted response rate</strong>: <span class="math inline">\(\sum_{i \in s_{cR}}d_i/\sum_{i \in s_c}d_i\)</span> where <span class="math inline">\(n_c\)</span> is the unweighted number of cases in class c</p></li>
<li><p><strong>Unweighted median</strong>: <span class="math inline">\(\hat{\phi}_c = median [\hat{\phi}(x_i)]_{i \in s_c}\)</span> where <span class="math inline">\(n_c\)</span> is the unweighted number of cases in class c</p></li>
</ol>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-27-contents" aria-controls="callout-27" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-27" class="callout-27-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>We compute the results for the case with 5 an 10 class respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>unw5<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span>p.class5<span class="sc">$</span>propensities, p.class5<span class="sc">$</span>p.class, mean)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>weigh5<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">preds=</span>p.class5<span class="sc">$</span>propensities, <span class="at">wt=</span>nhis[,<span class="st">"svywt"</span>]),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>         p.class5<span class="sc">$</span>p.class, <span class="cf">function</span>(x) {<span class="fu">weighted.mean</span>(x<span class="sc">$</span>preds,x<span class="sc">$</span>wt)})</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>unw.resp5<span class="ot">=</span><span class="fu">by</span>(<span class="fu">as.numeric</span>(nhis[,<span class="st">"resp"</span>]), p.class5<span class="sc">$</span>p.class, mean)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>weigh.resp5<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">resp=</span><span class="fu">as.numeric</span>(nhis[,<span class="st">"resp"</span>]),<span class="at">wt=</span>nhis[,<span class="st">"svywt"</span>]),</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>              p.class5<span class="sc">$</span>p.class, <span class="cf">function</span>(x) {<span class="fu">weighted.mean</span>(x<span class="sc">$</span>resp,x<span class="sc">$</span>wt)})</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>med5<span class="ot">=</span><span class="fu">by</span>(p.class5<span class="sc">$</span>propensities, p.class5<span class="sc">$</span>p.class, median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>unw10<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span>p.class10<span class="sc">$</span>propensities, p.class10<span class="sc">$</span>p.class, mean)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>weigh10<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">preds=</span>p.class10<span class="sc">$</span>propensities, <span class="at">wt=</span>nhis[,<span class="st">"svywt"</span>]),</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>         p.class10<span class="sc">$</span>p.class, <span class="cf">function</span>(x) {<span class="fu">weighted.mean</span>(x<span class="sc">$</span>preds,x<span class="sc">$</span>wt)})</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>unw.resp10<span class="ot">=</span><span class="fu">by</span>(<span class="fu">as.numeric</span>(nhis[,<span class="st">"resp"</span>]), p.class10<span class="sc">$</span>p.class, mean)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>weigh.resp10<span class="ot">=</span><span class="fu">by</span>(<span class="at">data=</span><span class="fu">data.frame</span>(<span class="at">resp=</span><span class="fu">as.numeric</span>(nhis[,<span class="st">"resp"</span>]),<span class="at">wt=</span>nhis[,<span class="st">"svywt"</span>]),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>              p.class10<span class="sc">$</span>p.class, <span class="cf">function</span>(x) {<span class="fu">weighted.mean</span>(x<span class="sc">$</span>resp,x<span class="sc">$</span>wt)})</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>med10<span class="ot">=</span><span class="fu">by</span>(p.class10<span class="sc">$</span>propensities, p.class10<span class="sc">$</span>p.class, median)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we compare the results considering the following tables:</p>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:right;"> Count of persons </th>
   <th style="text-align:right;"> Unw. avg. prop. </th>
   <th style="text-align:right;"> W. avg. prop. </th>
   <th style="text-align:right;"> Unw. RR </th>
   <th style="text-align:right;"> W. RR </th>
   <th style="text-align:right;"> Median </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> [0.477,0.651] </td>
   <td style="text-align:right;"> 783 </td>
   <td style="text-align:right;"> 0.6211 </td>
   <td style="text-align:right;"> 0.6237 </td>
   <td style="text-align:right;"> 0.6258 </td>
   <td style="text-align:right;"> 0.6447 </td>
   <td style="text-align:right;"> 0.6294 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.651,0.68] </td>
   <td style="text-align:right;"> 782 </td>
   <td style="text-align:right;"> 0.6656 </td>
   <td style="text-align:right;"> 0.6656 </td>
   <td style="text-align:right;"> 0.6662 </td>
   <td style="text-align:right;"> 0.6687 </td>
   <td style="text-align:right;"> 0.6651 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.68,0.706] </td>
   <td style="text-align:right;"> 782 </td>
   <td style="text-align:right;"> 0.6930 </td>
   <td style="text-align:right;"> 0.6933 </td>
   <td style="text-align:right;"> 0.6752 </td>
   <td style="text-align:right;"> 0.6861 </td>
   <td style="text-align:right;"> 0.6929 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.706,0.734] </td>
   <td style="text-align:right;"> 782 </td>
   <td style="text-align:right;"> 0.7195 </td>
   <td style="text-align:right;"> 0.7196 </td>
   <td style="text-align:right;"> 0.7353 </td>
   <td style="text-align:right;"> 0.7336 </td>
   <td style="text-align:right;"> 0.7201 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.734,0.777] </td>
   <td style="text-align:right;"> 782 </td>
   <td style="text-align:right;"> 0.7514 </td>
   <td style="text-align:right;"> 0.7521 </td>
   <td style="text-align:right;"> 0.7481 </td>
   <td style="text-align:right;"> 0.7626 </td>
   <td style="text-align:right;"> 0.7503 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:right;"> Count of persons </th>
   <th style="text-align:right;"> Unw. avg. prop. </th>
   <th style="text-align:right;"> W. avg. prop. </th>
   <th style="text-align:right;"> Unw. RR </th>
   <th style="text-align:right;"> W. RR </th>
   <th style="text-align:right;"> Median </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> [0.477,0.629] </td>
   <td style="text-align:right;"> 392 </td>
   <td style="text-align:right;"> 0.6008 </td>
   <td style="text-align:right;"> 0.6026 </td>
   <td style="text-align:right;"> 0.5765 </td>
   <td style="text-align:right;"> 0.5910 </td>
   <td style="text-align:right;"> 0.6090 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.629,0.651] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.6415 </td>
   <td style="text-align:right;"> 0.6416 </td>
   <td style="text-align:right;"> 0.6777 </td>
   <td style="text-align:right;"> 0.6933 </td>
   <td style="text-align:right;"> 0.6430 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.651,0.665] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.6586 </td>
   <td style="text-align:right;"> 0.6585 </td>
   <td style="text-align:right;"> 0.6573 </td>
   <td style="text-align:right;"> 0.6598 </td>
   <td style="text-align:right;"> 0.6586 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.665,0.68] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.6727 </td>
   <td style="text-align:right;"> 0.6727 </td>
   <td style="text-align:right;"> 0.6726 </td>
   <td style="text-align:right;"> 0.6754 </td>
   <td style="text-align:right;"> 0.6731 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.68,0.692] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.6861 </td>
   <td style="text-align:right;"> 0.6862 </td>
   <td style="text-align:right;"> 0.6854 </td>
   <td style="text-align:right;"> 0.6873 </td>
   <td style="text-align:right;"> 0.6860 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.692,0.706] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.6999 </td>
   <td style="text-align:right;"> 0.7001 </td>
   <td style="text-align:right;"> 0.6675 </td>
   <td style="text-align:right;"> 0.6866 </td>
   <td style="text-align:right;"> 0.7002 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.706,0.72] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.7131 </td>
   <td style="text-align:right;"> 0.7131 </td>
   <td style="text-align:right;"> 0.7161 </td>
   <td style="text-align:right;"> 0.7107 </td>
   <td style="text-align:right;"> 0.7126 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.72,0.734] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.7259 </td>
   <td style="text-align:right;"> 0.7260 </td>
   <td style="text-align:right;"> 0.7519 </td>
   <td style="text-align:right;"> 0.7543 </td>
   <td style="text-align:right;"> 0.7260 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.734,0.75] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.7408 </td>
   <td style="text-align:right;"> 0.7408 </td>
   <td style="text-align:right;"> 0.7570 </td>
   <td style="text-align:right;"> 0.7680 </td>
   <td style="text-align:right;"> 0.7411 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> (0.75,0.777] </td>
   <td style="text-align:right;"> 391 </td>
   <td style="text-align:right;"> 0.7619 </td>
   <td style="text-align:right;"> 0.7622 </td>
   <td style="text-align:right;"> 0.7391 </td>
   <td style="text-align:right;"> 0.7574 </td>
   <td style="text-align:right;"> 0.7610 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Overall, for both 5 and 10 classes, we observe that values generally increase across classes, with all five methods producing similar results. The first and last classes show a wider range of values.</p>
<p>When comparing the results between 5 and 10 classes, the range is narrower in the 10-class scenario. While using more classes can help reduce bias due to nonresponse, it may also lead to higher variances. Typically, 5 classes are recommended when the sample size is not large. In this case, opting for 5 classes seems appropriate.</p>
</div>
</div>
</div>
<ol start="2" type="1">
<li><strong>Check covariate balance according to D’Agostino method. Is balancing achieved? Discuss it.</strong></li>
</ol>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Checking Balance on Covariates - D’Agostino 1998
</div>
</div>
<div class="callout-body-container callout-body">
<p>The idea is simple: after classes are formed, you check if there is a difference in the covariate means. The covariate means should be different between classes but within a class the means of the covariates should be the same for respondents and nonrespondents. This is consistent with the idea that the response propensity is the same for all units withing a class.</p>
<p>To check balance on covariates you need to:</p>
<ul>
<li><p>for quantitative x’s: fit an ANOVA model, where <code>x = p.class + resp + p.class*resp</code></p></li>
<li><p>for dichtonomous x’s: fit a logistic model, where <code>logit(x) = p.class + resp + p.class*resp</code></p></li>
</ul>
<p>The coefficients on <code>resp</code> and the interaction <code>p.class*resp</code>shoud be nonsignificant.</p>
<p>The coefficients on <code>p.class</code>should be nonzero and different from each other</p>
<p>In addition you can also look at the covariate means table using <code>p.class*resp</code></p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-29-contents" aria-controls="callout-29" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-29" class="callout-29-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This is an example, you can proceed with all the covariates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>p.class <span class="ot">&lt;-</span> p.class5<span class="sc">$</span>p.class</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">#standard check</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>chk1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(age <span class="sc">~</span> p.class <span class="sc">+</span> resp <span class="sc">+</span> p.class<span class="sc">*</span>resp, <span class="at">data =</span> nhis)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># An additional step is to fit a second model that only inlcudes p.class </span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and test wether chk1 and chk2 are equivalent</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>chk2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(age <span class="sc">~</span> p.class, <span class="at">data =</span> nhis)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(chk1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = age ~ p.class + resp + p.class * resp, data = nhis)

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                60.5734     0.8252  73.404  &lt; 2e-16 ***
p.class(0.651,0.68]        -8.6768     1.2023  -7.217 6.35e-13 ***
p.class(0.68,0.706]       -16.0694     1.2110 -13.270  &lt; 2e-16 ***
p.class(0.706,0.734]      -19.8729     1.2825 -15.495  &lt; 2e-16 ***
p.class(0.734,0.777]      -32.5328     1.3014 -24.997  &lt; 2e-16 ***
resp                       -1.7448     1.0431  -1.673   0.0945 .  
p.class(0.651,0.68]:resp   -0.9099     1.4952  -0.609   0.5429    
p.class(0.68,0.706]:resp    3.8147     1.5005   2.542   0.0111 *  
p.class(0.706,0.734]:resp   2.6304     1.5489   1.698   0.0895 .  
p.class(0.734,0.777]:resp   2.4478     1.5627   1.566   0.1173    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 199.5216)

    Null deviance: 1188013  on 3910  degrees of freedom
Residual deviance:  778334  on 3901  degrees of freedom
AIC: 31823

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(chk2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = age ~ p.class, data = nhis)

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           59.4815     0.5053  117.70   &lt;2e-16 ***
p.class(0.651,0.68]   -9.3536     0.7149  -13.08   &lt;2e-16 ***
p.class(0.68,0.706]  -13.5799     0.7149  -19.00   &lt;2e-16 ***
p.class(0.706,0.734] -18.1298     0.7149  -25.36   &lt;2e-16 ***
p.class(0.734,0.777] -30.9150     0.7149  -43.24   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 199.9602)

    Null deviance: 1188013  on 3910  degrees of freedom
Residual deviance:  781044  on 3906  degrees of freedom
AIC: 31827

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(chk2, chk1, <span class="at">test=</span><span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Deviance Table

Model 1: age ~ p.class
Model 2: age ~ p.class + resp + p.class * resp
  Resid. Df Resid. Dev Df Deviance Pr(&gt;Chi)  
1      3906     781044                       
2      3901     778334  5   2710.7  0.01846 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#p-val non significant: balance is fine</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">#For hispanic you need to recode the data.</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>new.hisp <span class="ot">&lt;-</span> <span class="fu">abs</span>(nhis<span class="sc">$</span>hisp<span class="dv">-2</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#standard check</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>chk1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(new.hisp <span class="sc">~</span> p.class <span class="sc">+</span> resp <span class="sc">+</span> p.class<span class="sc">*</span>resp, <span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> nhis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
A numerical note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When running a model to check balance on covariates, you might encounter anomalous results, such as extremely large estimates of standard errors. This could indicate “quasi-complete” separation in the dataset, where one or more observations have a predicted probability very close to 1. In such cases, a parameter estimate may diverge to infinity.</p>
<p>While this poses a significant problem if your goal is to identify covariates associated with the occurrence of a particular characteristic, it does not affect the formation of propensity classes when checking covariate balance.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Congratulations! 🎉
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve successfully completed these exercises! By now, you should have a solid understanding of nonresponse.</p>
<p>To keep building your skills, here are a few extra exercises:</p>
<ul>
<li><p><a href="https://www.youtube.com/watch?v=E5SjP5Dd2sI&amp;t=2s"><strong>Tailored weights in longitudinal surveys</strong></a>: you can find a Stata tutorial by the UK Understanding Society survey</p></li>
<li><p><strong>Check covariate balance</strong>: Do the <em>extra exercise</em> in the propensity score stratification section</p></li>
<li><p><strong>Apply what you’ve learned</strong>: Try using these models on your own data</p></li>
</ul>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="adjusting-for-nonresponse-and-coverage" class="level1">
<h1><strong>Adjusting for Nonresponse and Coverage</strong></h1>
<p>In this exercise we use a larger version of the NHIS dataset that we used in the previous exercise. This dataset, named <code>nhis.large,</code> also contain some health-related variables. We want to estimate the number of persons covered by Medicaid, a type of US governamental assistance for medical care provided to the poor.</p>
<p>We treat the large sample as reference population data. To the purpose of our exercise we also consider a probability sample which is extracted from the NHIS dataset but introducing coverage errors.</p>
<p>Your objective is to perform different adjustment methods, namely, poststratification, raking and GREG calibration.</p>
<ol type="1">
<li><strong>Load the data</strong></li>
</ol>
<p>Load the <code>nhis.large</code> dataset and recode <code>hisp</code> into three categories (collapse category 4 and 3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"nhis.large"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>nhis.large1 <span class="ot">&lt;-</span> nhis.large <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hisp.r =</span> <span class="fu">ifelse</span>(hisp<span class="sc">==</span><span class="dv">4</span>,<span class="dv">3</span>,hisp))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"samdat.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><p><strong>Define the sampling design of the sample</strong></p>
<p>This time specify the weights (N/n) and the finite population correction equal to the sampling fraction (n/N)</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-32-contents" aria-controls="callout-32" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-32" class="callout-32-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(nhis.large1)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span><span class="fu">nrow</span>(samdat)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">rep</span>(N<span class="sc">/</span>n, n)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">&lt;-</span> <span class="fu">rep</span>(n<span class="sc">/</span>N, n)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>nhis.dsgn <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span><span class="dv">0</span>,    <span class="co"># no clusters </span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">strata =</span> <span class="cn">NULL</span>,    <span class="co"># no strata</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">fpc =</span> <span class="sc">~</span>f1,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> <span class="fu">data.frame</span>(samdat), </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">weights =</span> <span class="sc">~</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<section id="poststratification" class="level3">
<h3 class="anchored" data-anchor-id="poststratification"><strong>Poststratification</strong></h3>
<ol type="1">
<li><strong>Compute the population total in the poststrata defined by <code>age.grp</code> and <code>hisp.r</code></strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-33-contents" aria-controls="callout-33" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-33" class="callout-33-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>    N.PS <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(<span class="sc">~</span> age.grp <span class="sc">+</span> hisp.r, <span class="at">data =</span> nhis.large1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li><strong>Implement <code>postStratify</code> specifying <code>age.grp + hisp.r</code> in the strata argument.</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-34-contents" aria-controls="callout-34" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-34" class="callout-34-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>    ps.dsgn <span class="ot">&lt;-</span> <span class="fu">postStratify</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">strata =</span> <span class="sc">~</span>age.grp <span class="sc">+</span> hisp.r,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">population =</span> N.PS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="raking" class="level3">
<h3 class="anchored" data-anchor-id="raking"><strong>Raking</strong></h3>
<ol type="1">
<li><p><strong>Compute the population total for the variable <code>age.grp</code> and <code>hisp.r</code></strong></p>
<p>Give appropriate names that match variable names in the raking and GREG models.</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-35-contents" aria-controls="callout-35" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-35" class="callout-35-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>N.age <span class="ot">&lt;-</span> <span class="fu">table</span>(nhis.large1[, <span class="st">"age.grp"</span>])</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>N.hisp <span class="ot">&lt;-</span> <span class="fu">table</span>(nhis.large1[, <span class="st">"hisp.r"</span>])</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>pop.totals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'(Intercept)'</span> <span class="ot">=</span> N, N.age[<span class="sc">-</span><span class="dv">1</span>], N.hisp[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pop.totals)<span class="ot">=</span><span class="fu">c</span>(<span class="st">"(Intercept)"</span>,<span class="st">"as.factor(age.grp)2"</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(age.grp)3"</span>, <span class="st">"as.factor(age.grp)4"</span>,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(age.grp)5"</span> ,<span class="st">"as.factor(hisp.r)2"</span>, </span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(hisp.r)3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li><strong>Implement raking specifying <code>~ as.factor(age.grp) + as.factor(hisp.r)</code> in the <code>formula</code> argument.</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-36-contents" aria-controls="callout-36" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-36" class="callout-36-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>rake.dsgn <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(age.grp) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp.r),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"raking"</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop.totals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="3" type="1">
<li><p><strong>Verify that weights are calibrated for x’s</strong></p>
<p>Compare the total for <code>age.grp</code> and <code>hisp.r</code> computed using <code>rake.dsgn</code> with the population totals <code>pop.totals</code></p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-37-contents" aria-controls="callout-37" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-37" class="callout-37-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(age.grp), rake.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    total SE
as.factor(age.grp)1  5991  0
as.factor(age.grp)2  2014  0
as.factor(age.grp)3  6124  0
as.factor(age.grp)4  5011  0
as.factor(age.grp)5  2448  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(hisp.r), rake.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   total SE
as.factor(hisp.r)1  5031  0
as.factor(hisp.r)2 12637  0
as.factor(hisp.r)3  3920  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>pop.totals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) as.factor(age.grp)2 as.factor(age.grp)3 as.factor(age.grp)4 
              21588                2014                6124                5011 
as.factor(age.grp)5  as.factor(hisp.r)2  as.factor(hisp.r)3 
               2448               12637                3920 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="greg" class="level3">
<h3 class="anchored" data-anchor-id="greg"><strong>GREG</strong></h3>
<ol type="1">
<li><strong>Implement GREG calibration specifying <code>~ as.factor(age.grp) + as.factor(hisp.r)</code> in the <code>formula</code> argument.</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-38-contents" aria-controls="callout-38" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-38" class="callout-38-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>greg.dsgn <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(age.grp) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp.r),</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"linear"</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop.totals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li><p><strong>Verify that weights are calibrated for x’s</strong></p>
<p>Compare the total for <code>age.grp</code> and <code>hisp.r</code> computed using <code>greg.dsgn</code> with the population totals <code>pop.totals</code></p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-39-contents" aria-controls="callout-39" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-39" class="callout-39-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(age.grp), greg.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    total SE
as.factor(age.grp)1  5991  0
as.factor(age.grp)2  2014  0
as.factor(age.grp)3  6124  0
as.factor(age.grp)4  5011  0
as.factor(age.grp)5  2448  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(hisp.r), greg.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   total SE
as.factor(hisp.r)1  5031  0
as.factor(hisp.r)2 12637  0
as.factor(hisp.r)3  3920  0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>pop.totals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) as.factor(age.grp)2 as.factor(age.grp)3 as.factor(age.grp)4 
              21588                2014                6124                5011 
as.factor(age.grp)5  as.factor(hisp.r)2  as.factor(hisp.r)3 
               2448               12637                3920 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="compare-the-three-methods" class="level3">
<h3 class="anchored" data-anchor-id="compare-the-three-methods"><strong>Compare the three methods</strong></h3>
<p>Compute the total and the proportion of individuals covered by Medicaid (1=yes, 2=no) using:</p>
<ol type="1">
<li><p>the original sampling weights</p></li>
<li><p>the poststratification weights</p></li>
<li><p>the raking weights</p></li>
<li><p>the GREG weights</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-40-contents" aria-controls="callout-40" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-40" class="callout-40-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), nhis.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  1823.8 250.18
as.factor(medicaid)2 17190.2 272.46</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), ps.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2492.1 317.07
as.factor(medicaid)2 18638.1 334.06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), rake.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2555.9 330.66
as.factor(medicaid)2 18516.9 351.43</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), greg.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2534.3 327.89
as.factor(medicaid)2 18539.7 349.04</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svyciprop</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid)<span class="sc">==</span><span class="dv">1</span>, nhis.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  2.5% 97.5%
as.factor(medicaid) == 1 0.0959 0.0730  0.13</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svyciprop</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid)<span class="sc">==</span><span class="dv">1</span>, ps.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  2.5% 97.5%
as.factor(medicaid) == 1 0.1179 0.0916  0.15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svyciprop</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid)<span class="sc">==</span><span class="dv">1</span>, rake.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  2.5% 97.5%
as.factor(medicaid) == 1 0.1213 0.0938  0.16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svyciprop</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid)<span class="sc">==</span><span class="dv">1</span>, greg.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                2.5% 97.5%
as.factor(medicaid) == 1 0.120 0.093  0.15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#true</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(nhis.large1[, <span class="st">"medicaid"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        1         2 
0.1071194 0.8928806 </code></pre>
</div>
</div>
<p>The results are quite similar.</p>
</div>
</div>
</div>
</section>
<section id="extra-exercises-1" class="level3">
<h3 class="anchored" data-anchor-id="extra-exercises-1"><strong>Extra exercises</strong></h3>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Poststratify vs GREG
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that applying poststratification with a single variable is equivalent to apply GREG.</p>
</div>
</div>
<ol type="1">
<li><p><strong>Apply poststratification and then GREG considering only <code>age.grp</code>.</strong></p>
<p>Remember to define population total (and names) again.</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-42-contents" aria-controls="callout-42" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-42" class="callout-42-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>N.PS1 <span class="ot">&lt;-</span> <span class="fu">xtabs</span>(<span class="sc">~</span> age.grp, <span class="at">data =</span> nhis.large1)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(nhis.large1)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>N.age <span class="ot">&lt;-</span> <span class="fu">table</span>(nhis.large1[, <span class="st">"age.grp"</span>])</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>pop.totals1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'(Intercept)'</span> <span class="ot">=</span> N, N.age[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pop.totals1)<span class="ot">=</span><span class="fu">c</span>(<span class="st">"(Intercept)"</span>,<span class="st">"as.factor(age.grp)2"</span>,</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(age.grp)3"</span>,</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(age.grp)4"</span>,</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"as.factor(age.grp)5"</span>)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>ps.dsgn1 <span class="ot">&lt;-</span> <span class="fu">postStratify</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>                            <span class="at">strata =</span> <span class="sc">~</span>age.grp,</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">population =</span> N.PS1)</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>greg.dsgn1 <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(age.grp),</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"linear"</span>,</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop.totals1)</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), ps.dsgn1, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2211.4 292.27
as.factor(medicaid)2 18919.9 315.91</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), greg.dsgn1, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2211.4 292.27
as.factor(medicaid)2 18919.9 315.91</code></pre>
</div>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li><strong>Continue the GREG exercise and trim your weights to be between 30 and 65</strong></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-43-contents" aria-controls="callout-43" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-43" class="callout-43-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>greg.trim <span class="ot">&lt;-</span> <span class="fu">trimWeights</span>(<span class="at">design =</span> greg.dsgn,</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="at">lower =</span> <span class="dv">30</span>,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="at">upper =</span> <span class="dv">65</span>,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="at">strict =</span> <span class="cn">TRUE</span>)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), greg.dsgn, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2534.3 327.89
as.factor(medicaid)2 18539.7 349.04</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svytotal</span>(<span class="sc">~</span><span class="fu">as.factor</span>(medicaid), greg.trim, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       total     SE
as.factor(medicaid)1  2502.3 323.26
as.factor(medicaid)2 18569.2 345.89</code></pre>
</div>
</div>
</div>
</div>
</div>
<ol start="3" type="1">
<li><strong>Repeat the GREG calibration specifying that the final weights should be between 0.5 and 1.5 times the original weights. Does the calibration work or fail?</strong></li>
</ol>
<p>Hint: Use <code>bounds = c(0.5,1.5)</code></p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-44-contents" aria-controls="callout-44" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-44" class="callout-44-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>greg.bound <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nhis.dsgn,</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(age.grp) <span class="sc">+</span> <span class="fu">as.factor</span>(hisp.r),</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"linear"</span>,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop.totals,</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bounds =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">1.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The calibration algorithm fails.</p>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Congratulations! 🎉
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve successfully completed these exercises! By now, you should have a solid understanding of survey weighting.</p>
<p>To keep building your skills, here are a few extra suggesions:</p>
<ul>
<li><p><strong>Have a look at the extra exercises</strong>: try out different bounds</p></li>
<li><p><strong>Apply what you’ve learned</strong>: Try using these models on your own data</p></li>
<li><p><strong>The Election Challange</strong>: Apply these methods in Day 4, to correct for selection bias</p></li>
</ul>
</div>
</div>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>Some of the exercises are adapted from:</p>
<ul>
<li><p>Valliant, R., Dever, J. A., &amp; Kreuter, F. (2018). <em>Practical tools for designing and weighting survey samples</em> (Vol. 1). New York: Springer.</p></li>
<li><p><a href="https://www.understandingsociety.ac.uk/help/training/creating-tailored-weights/">Creating Tailored Weights</a> - by Understanding Society</p></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>