<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Camilla Salvatore">

<title>Survey data Integration and Inference with Nonprobability Samples</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="Data_Int_nonprob_workshop_files/libs/clipboard/clipboard.min.js"></script>
<script src="Data_Int_nonprob_workshop_files/libs/quarto-html/quarto.js"></script>
<script src="Data_Int_nonprob_workshop_files/libs/quarto-html/popper.min.js"></script>
<script src="Data_Int_nonprob_workshop_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Data_Int_nonprob_workshop_files/libs/quarto-html/anchor.min.js"></script>
<link href="Data_Int_nonprob_workshop_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Data_Int_nonprob_workshop_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Data_Int_nonprob_workshop_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Data_Int_nonprob_workshop_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Data_Int_nonprob_workshop_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><strong>Introduction</strong></a></li>
  <li><a href="#frequentist-approaches" id="toc-frequentist-approaches" class="nav-link" data-scroll-target="#frequentist-approaches"><strong>Frequentist approaches</strong></a>
  <ul class="collapse">
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><strong>The data</strong></a>
  <ul class="collapse">
  <li><a href="#preliminary-analyses" id="toc-preliminary-analyses" class="nav-link" data-scroll-target="#preliminary-analyses"><strong>Preliminary analyses</strong></a></li>
  </ul></li>
  <li><a href="#classic-approaches-in-weighting" id="toc-classic-approaches-in-weighting" class="nav-link" data-scroll-target="#classic-approaches-in-weighting"><strong>Classic approaches in weighting</strong></a></li>
  <li><a href="#inverse-probability-weighting" id="toc-inverse-probability-weighting" class="nav-link" data-scroll-target="#inverse-probability-weighting"><strong>Inverse-probability weighting</strong></a>
  <ul class="collapse">
  <li><a href="#when-a-probability-sample-is-available" id="toc-when-a-probability-sample-is-available" class="nav-link" data-scroll-target="#when-a-probability-sample-is-available"><strong>When a probability sample is available</strong></a></li>
  <li><a href="#when-only-population-information-is-available" id="toc-when-only-population-information-is-available" class="nav-link" data-scroll-target="#when-only-population-information-is-available"><strong>When only population information is available</strong></a></li>
  </ul></li>
  <li><a href="#mass-imputation" id="toc-mass-imputation" class="nav-link" data-scroll-target="#mass-imputation"><strong>Mass Imputation</strong></a>
  <ul class="collapse">
  <li><a href="#when-a-probability-sample-is-available-1" id="toc-when-a-probability-sample-is-available-1" class="nav-link" data-scroll-target="#when-a-probability-sample-is-available-1"><strong>When a probability sample is available</strong></a></li>
  <li><a href="#when-only-population-information-is-available-1" id="toc-when-only-population-information-is-available-1" class="nav-link" data-scroll-target="#when-only-population-information-is-available-1"><strong>When only population information is available</strong></a></li>
  </ul></li>
  <li><a href="#doubly-robust-inference" id="toc-doubly-robust-inference" class="nav-link" data-scroll-target="#doubly-robust-inference"><strong>Doubly-robust inference</strong></a>
  <ul class="collapse">
  <li><a href="#when-a-probability-sample-is-available-2" id="toc-when-a-probability-sample-is-available-2" class="nav-link" data-scroll-target="#when-a-probability-sample-is-available-2"><strong>When a probability sample is available</strong></a></li>
  <li><a href="#when-only-population-information-is-available-2" id="toc-when-only-population-information-is-available-2" class="nav-link" data-scroll-target="#when-only-population-information-is-available-2"><strong>When only population information is available</strong></a></li>
  </ul></li>
  <li><a href="#comparing-the-results" id="toc-comparing-the-results" class="nav-link" data-scroll-target="#comparing-the-results"><strong>Comparing the results</strong></a></li>
  </ul></li>
  <li><a href="#bayesian-approaches" id="toc-bayesian-approaches" class="nav-link" data-scroll-target="#bayesian-approaches"><strong>Bayesian approaches</strong></a>
  <ul class="collapse">
  <li><a href="#multilevel-regression-and-post-stratification" id="toc-multilevel-regression-and-post-stratification" class="nav-link" data-scroll-target="#multilevel-regression-and-post-stratification"><strong>Multilevel regression and post-stratification</strong></a>
  <ul class="collapse">
  <li><a href="#the-data-1" id="toc-the-data-1" class="nav-link" data-scroll-target="#the-data-1"><strong>The data</strong></a></li>
  <li><a href="#preliminary-analyses-1" id="toc-preliminary-analyses-1" class="nav-link" data-scroll-target="#preliminary-analyses-1"><strong>Preliminary analyses</strong></a></li>
  <li><a href="#the-mister-mr" id="toc-the-mister-mr" class="nav-link" data-scroll-target="#the-mister-mr"><strong>The Mister: MR</strong></a></li>
  <li><a href="#the-p-postststratification" id="toc-the-p-postststratification" class="nav-link" data-scroll-target="#the-p-postststratification"><strong>The P: Postststratification</strong></a></li>
  <li><a href="#compare-the-results" id="toc-compare-the-results" class="nav-link" data-scroll-target="#compare-the-results"><strong>Compare the results</strong></a></li>
  </ul></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong>Survey data Integration and Inference with Nonprobability Samples</strong></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Camilla Salvatore </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1><strong>Introduction</strong></h1>
<p>This material is part of the workshop “Survey data integration: strategies for data collection and analyses” organized during the <a href="https://www.herss-summer.eu/current/programme">HERSS 2024 Summer School</a>.</p>
<p>In this practical session we learn how to do inference with nonprobability samples; in the first part we discuss frequentist approaches (Inverse probability weighting, mass imputation and doubly robust methods) and in the second part the Bayesian MRP.</p>
</section>
<section id="frequentist-approaches" class="level1">
<h1><strong>Frequentist approaches</strong></h1>
<p>In these exercises we use the <code>nonprobsvy</code> package developed by Maciej Beręsewicz and Łukasz Chrostowski. You can find additional information about the package here:</p>
<ul>
<li><p><a href="https://htmlpreview.github.io/?https://github.com/ncn-foreigners/software-tutorials/main/notebooks/2023-nonprobsvy-basic-usecases.html">Basic use cases of the nonprobsvy package</a>;</p></li>
<li><p><a href="https://ncn-foreigners.github.io/nonprobsvy-book/">Modern inference methods for non-probability samples with R</a>;</p></li>
<li><p>GitHub <a href="https://github.com/BERENZ/nonprobsvy">repository</a>;</p></li>
<li><p>A video of a <a href="https://www.youtube.com/watch?v=ZcOzGK6jhSg">workshop</a> on nonprobsvy.</p></li>
</ul>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data"><strong>The data</strong></h2>
<p>In this exercise, we will analyze data from the 2003 U.S. Michigan Behavioral Risk Factor Surveillance Survey, available in the <code>PracTools</code> package. The dataset, named <code>mibrfss</code>, includes various demographic and health-related variables. We use this dataset as the basis in order to simulate a population of size <code>100000</code> and different sampling scenarios. In particular, the data we provide you with are:</p>
<ol type="1">
<li><p><strong>Population Totals</strong>: <code>pop_tot.rda</code> – Contains population totals.</p></li>
<li><p><strong>Probability Sample (PS)</strong>: <code>p_sample.rda</code> – A high-quality sample of size 10,000, assumed to be a simple random sample.</p></li>
<li><p><strong>Non-Probability Sample (NPS)</strong>: <code>np_sample.rda</code> – A sample of size 1,000 with self-selection and coverage issues.</p></li>
</ol>
<p>We consider a subset of the variables available in the <code>mibrfss</code> dataset, namely:</p>
<ul>
<li><p><code>SMOKE100</code> : Smoked 100 or more cigarettes in lifetime (1 = Yes; 2 = No)</p></li>
<li><p><code>AGECAT</code> : Age group (1 = 18-24 years; 2 = 25-34 years; 3 = 35-44 years; 4 = 45-54 years; 5 = 55-64 years; 6 = 65+)</p></li>
<li><p><code>INETHOME</code> : Has access to the Internet at home (1 = Yes; 2 = No)</p></li>
<li><p><code>EDCAT</code> : Education level (1 = Did not graduate high school; 2 = Graduated high school; 3 = Attended college or technical school; 4 = Graduated from college or technical school)</p></li>
</ul>
<p>For this exercise, we assume that the non-probability sample (NPS) was collected through social media advertisements. This approach introduces potential biases because only individuals with internet access and who are active on the specific social media platform could participate. Consequently, the NPS may suffer from both self-selection bias and coverage bias (since the sample is restricted to those with internet access and a presence on social media).</p>
<p>In contrast, we assume that the probability sample (PS) was obtained through a simple random sampling method. This sample is considered a high-quality reference sample, and for simplicity, we do not need to account for any design or calibration weights.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Estimate the proportion of U.S. individuals aged 18+ who smoked 100 or more cigarettes in their lifetime</p></li>
<li><p>Compare different estimation techniques against the true population value of 52.85%</p></li>
</ul>
</div>
</div>
<section id="preliminary-analyses" class="level3">
<h3 class="anchored" data-anchor-id="preliminary-analyses"><strong>Preliminary analyses</strong></h3>
<ol type="1">
<li><strong>Before starting, load the necessary R packages:</strong></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nonprobsvy)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PracTools)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><strong>Import and prepare the data:</strong> Load the datasets and inspect the data. Pay attention to the data format.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"p_sample.rda"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"np_sample.rda"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"pop_tot.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Task:</strong> Familiarize yourself with the datasets.</p>
<div class="callout-note callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>The PS survey does not contain the target variable of interest, i.e., <code>SMOKE100</code></p></li>
<li><p>You might encounter some issues when the variables are categorical. I suggest to save binary variables as numeric and variables with more than one level as character.</p></li>
<li><p>Pay attention to the <code>pop_tot</code> structure. It contains the population totals and it is formatted in order to match the <code>nonprobsvy</code> and <code>survey</code> package naming terminology. The <code>(Intercept)</code> simply contains the size of the population.</p></li>
</ul>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pop_tot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)     AGECAT2     AGECAT3     AGECAT4     AGECAT5     AGECAT6 
     100000       13408       19554       22526       16875       21879 
   RACECAT2    RACECAT3      EDCAT2      EDCAT3      EDCAT4   INETHOME1 
       8255        5113       30925       28464       31668       65370 </code></pre>
</div>
</div>
<ol start="3" type="1">
<li><p><strong>Compare the distribution of the covariates in the probability and nonprobability samples:</strong></p>
<p>You can use <code>prop.table</code>.</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Age</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(p_sample<span class="sc">$</span>AGECAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1      2      3      4      5      6 
0.0564 0.1351 0.1992 0.2211 0.1718 0.2164 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(np_sample<span class="sc">$</span>AGECAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    1     2     3     4     5     6 
0.126 0.143 0.219 0.241 0.152 0.119 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Race</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(p_sample<span class="sc">$</span>RACECAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1      2      3 
0.8699 0.0792 0.0509 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(np_sample<span class="sc">$</span>RACECAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    1     2     3 
0.878 0.061 0.061 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Education</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(p_sample<span class="sc">$</span>EDCAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     1      2      3      4 
0.0875 0.3109 0.2801 0.3215 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(np_sample<span class="sc">$</span>EDCAT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    1     2     3     4 
0.111 0.256 0.267 0.366 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Internet at home</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(p_sample<span class="sc">$</span>INETHOME))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
0.35 0.65 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prop.table</span>(<span class="fu">table</span>(np_sample<span class="sc">$</span>INETHOME))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1 
0.04 0.96 </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Individuals in the nonprobability samples are more young, with more graduated from collage or technical school higher education and mainly with internet at home.</p>
<ol start="4" type="1">
<li><strong>Define the sampling desing:</strong> Specify the sampling designs for both the PS and NPS samples using the <code>svydesign</code> function.</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ps_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span> <span class="dv">1</span>,<span class="at">data =</span> p_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in svydesign.default(ids = ~1, data = p_sample): No weights or
probabilities supplied, assuming equal probability</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>nps_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span> <span class="dv">1</span>,<span class="at">data =</span> np_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in svydesign.default(ids = ~1, data = np_sample): No weights or
probabilities supplied, assuming equal probability</code></pre>
</div>
</div>
</div>
</div>
</div>
<ol start="5" type="1">
<li><strong>Estimate Proportion from Non-Probability Sample</strong></li>
</ol>
<p>Use the <code>svymean</code> and/or <code>svyciprop</code> functions to calculate the proportion and its confidence interval. Save it in a <code>compare</code> tibble where you will add the estimates obtained with different methods.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svymean</span>(<span class="sc">~</span> SMOKE100, nps_design)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mean     SE
SMOKE100 0.489 0.0158</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>np_est<span class="ot">=</span><span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, nps_design)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>np_est</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                2.5% 97.5%
SMOKE100 0.489 0.458  0.52</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ci<span class="ot">=</span><span class="fu">confint</span>(<span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, nps_design))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">estimate=</span>np_est[<span class="dv">1</span>], </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">lower_bound=</span>ci[<span class="dv">1</span>],</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">upper_bound=</span>ci[<span class="dv">2</span>], </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">method=</span><span class="st">"nps"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate of the proportion of individuals who smoked 100 or more cigarettes in their lifetime from the non-probability sample (NPS) is 48.9%, with a 95% confidence interval ranging from 45.8% to 52.0%. Note that the confidence interval does not include the true population proportion.</p>
<p>To improve our estimate, we will apply and compare various estimation techniques.</p>
</section>
</section>
<section id="classic-approaches-in-weighting" class="level2">
<h2 class="anchored" data-anchor-id="classic-approaches-in-weighting"><strong>Classic approaches in weighting</strong></h2>
<p>In this part we will apply to standard approaches: raking and calibration.</p>
<ol type="1">
<li>Start with raking. Follow the code in the slides and include the following variables <code>AGECAT</code>, <code>RACECAT</code>, <code>EDCAT</code>, and <code>INETHOME</code></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>rake.dsgn <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nps_design,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"raking"</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop_tot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Now implement GREG. Consider the same variables as before</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>greg.dsgn <span class="ot">&lt;-</span> <span class="fu">calibrate</span>(<span class="at">design =</span> nps_design,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">formula =</span> <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">calfun =</span> <span class="st">"linear"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">population =</span> pop_tot)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#some weights are negative, we trim them</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>greg.dsgn<span class="ot">&lt;-</span><span class="fu">trimWeights</span>(greg.dsgn,<span class="at">lower=</span><span class="dv">0</span>, <span class="at">upper=</span><span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="3" type="1">
<li>Save the estimates and the confidence intervals that you obtain</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>np_rake<span class="ot">=</span><span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, rake.dsgn)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>np_rake</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                2.5% 97.5%
SMOKE100 0.545 0.491   0.6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ci<span class="ot">=</span><span class="fu">confint</span>(<span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, rake.dsgn))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">estimate=</span>np_rake[<span class="dv">1</span>], </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">lower_bound=</span>ci[<span class="dv">1</span>],</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">upper_bound=</span>ci[<span class="dv">2</span>], </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">method=</span><span class="st">"raking"</span>))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>np_greg<span class="ot">=</span><span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, greg.dsgn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.glm(g): observations with zero weight not used for
calculating dispersion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.glm(glm.object): observations with zero weight not used for
calculating dispersion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>np_greg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                2.5% 97.5%
SMOKE100 0.528 0.474  0.58</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ci<span class="ot">=</span><span class="fu">confint</span>(<span class="fu">svyciprop</span>(<span class="sc">~</span> SMOKE100, greg.dsgn))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.glm(g): observations with zero weight not used for
calculating dispersion

Warning in summary.glm(g): observations with zero weight not used for
calculating dispersion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">estimate=</span>np_greg[<span class="dv">1</span>], </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">lower_bound=</span>ci[<span class="dv">1</span>],</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">upper_bound=</span>ci[<span class="dv">2</span>], </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">method=</span><span class="st">"greg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="inverse-probability-weighting" class="level2">
<h2 class="anchored" data-anchor-id="inverse-probability-weighting"><strong>Inverse-probability weighting</strong></h2>
<section id="when-a-probability-sample-is-available" class="level3">
<h3 class="anchored" data-anchor-id="when-a-probability-sample-is-available"><strong>When a probability sample is available</strong></h3>
<p>First, we assume that we have access to high quality data from a reference probability sample. Implement IPW using the <code>nonprob</code> function with the following specifications:</p>
<ol type="1">
<li><p>Set up a selection model that includes the variables <code>AGECAT</code>, <code>RACECAT</code>, <code>EDCAT</code>, and <code>INETHOME</code></p></li>
<li><p>Use as <code>target</code> variable <code>SMOKE100</code></p></li>
<li><p>Use the probability sample design you created before as input for <code>svydesign</code></p></li>
<li><p>Use logistic regression in <code>method_selection</code></p></li>
<li><p>Save the estimate and the confidence interval</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ipw_logit_ps <span class="ot">&lt;-</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nonprob</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">selection =</span> <span class="sc">~</span> <span class="fu">as.factor</span>(AGECAT) <span class="sc">+</span> <span class="fu">as.factor</span>(RACECAT) <span class="sc">+</span> <span class="fu">as.factor</span>(EDCAT) <span class="sc">+</span> <span class="fu">as.factor</span>(INETHOME),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="sc">~</span> SMOKE100,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> np_sample,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">svydesign  =</span> ps_design,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_selection =</span> <span class="st">"logit"</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(ipw_logit_ps<span class="sc">$</span>output, ipw_logit_ps<span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5302948 0.03644835   0.4588573   0.6017322</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">estimate=</span>ipw_logit_ps<span class="sc">$</span>output<span class="sc">$</span>mean, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">lower_bound=</span>ipw_logit_ps<span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">upper_bound=</span>ipw_logit_ps<span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound, </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">method=</span><span class="st">"ipw_ps"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate is 53.02% (CI: 45.88% - 60.17%). This estimate is much closer to the true population proportion of 52.85%, and the confidence interval now includes the true value.</p>
</section>
<section id="when-only-population-information-is-available" class="level3">
<h3 class="anchored" data-anchor-id="when-only-population-information-is-available"><strong>When only population information is available</strong></h3>
<p>Now we assume that only population totals are available.</p>
<ol type="1">
<li>Implement IPW using the <code>nonprob</code> function with the previous specifications but instead of <code>svydesign</code> , specify the <code>pop_totals</code>.</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>ipw_logit_poptotals <span class="ot">&lt;-</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nonprob</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">selection =</span>  <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="sc">~</span> SMOKE100,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> np_sample,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_totals =</span> pop_tot,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">method_selection =</span> <span class="st">"logit"</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(ipw_logit_poptotals<span class="sc">$</span>output, ipw_logit_poptotals<span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5449075 0.07954355    0.389005     0.70081</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> ipw_logit_poptotals<span class="sc">$</span>output<span class="sc">$</span>mean,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_bound =</span> ipw_logit_poptotals<span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_bound =</span> ipw_logit_poptotals<span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"ipw_pop_tot"</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Now, the estimate is 54.49% but the confidence interval is quite large (CI: 38.9% - 70%). This wide interval suggests considerable uncertainty in the estimate.</p>
</section>
</section>
<section id="mass-imputation" class="level2">
<h2 class="anchored" data-anchor-id="mass-imputation"><strong>Mass Imputation</strong></h2>
<section id="when-a-probability-sample-is-available-1" class="level3">
<h3 class="anchored" data-anchor-id="when-a-probability-sample-is-available-1"><strong>When a probability sample is available</strong></h3>
<p>First, we assume that we have access to high quality data from a reference probability sample. Implement Mass Imputation using the <code>nonprob</code> function with the following specifications:</p>
<ol type="1">
<li><p>Set up an outcome model for <code>SMOKE100</code> that includes the variables <code>AGECAT</code>, <code>RACECAT</code>, <code>EDCAT</code>, and <code>INETHOME</code></p></li>
<li><p>Use the probability sample design you created before as input for <code>svydesign</code></p></li>
<li><p>Given the outcome type, select the correct option for the <code>method_outcome</code> and <code>family_outcome</code></p></li>
<li><p>Save the estimate and the confidence interval</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-11-contents" aria-controls="callout-11" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-11" class="callout-11-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>mi_sample <span class="ot">&lt;-</span> <span class="fu">nonprob</span>(<span class="at">outcome =</span> SMOKE100 <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> np_sample,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">svydesign =</span> ps_design,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method_outcome =</span> <span class="st">"glm"</span>,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">family_outcome =</span> <span class="st">"binomial"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(mi_sample<span class="sc">$</span>output, mi_sample<span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5284921 0.02853384   0.4725668   0.5844174</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> mi_sample<span class="sc">$</span>output<span class="sc">$</span>mean,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_bound =</span> mi_sample<span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_bound =</span> mi_sample<span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"mi_sample"</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate is 52.84% (CI: 47.1% - 58.4%).</p>
</section>
<section id="when-only-population-information-is-available-1" class="level3">
<h3 class="anchored" data-anchor-id="when-only-population-information-is-available-1"><strong>When only population information is available</strong></h3>
<p>Now we assume that only population totals are available.</p>
<ol type="1">
<li>Implement Mass Imputation using the <code>nonprob</code> function with the previous specifications but instead of <code>svydesign</code> , specify the <code>pop_totals</code>.</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-12-contents" aria-controls="callout-12" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-12" class="callout-12-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mi_poptotals <span class="ot">&lt;-</span> <span class="fu">nonprob</span>(<span class="at">outcome =</span> SMOKE100 <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> np_sample,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pop_totals =</span> pop_tot,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">method_outcome =</span> <span class="st">"glm"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">family_outcome =</span> <span class="st">"binomial"</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(mi_poptotals<span class="sc">$</span>output,mi_poptotals<span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5303917 0.03275615   0.4661909   0.5945926</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> mi_poptotals<span class="sc">$</span>output<span class="sc">$</span>mean,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_bound =</span> mi_poptotals<span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_bound =</span> mi_poptotals<span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"mi_pop_tot"</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate is 53.04% (CI: 46.6% - 59.5%).</p>
</section>
</section>
<section id="doubly-robust-inference" class="level2">
<h2 class="anchored" data-anchor-id="doubly-robust-inference"><strong>Doubly-robust inference</strong></h2>
<section id="when-a-probability-sample-is-available-2" class="level3">
<h3 class="anchored" data-anchor-id="when-a-probability-sample-is-available-2"><strong>When a probability sample is available</strong></h3>
<p>First, we assume that we have access to high quality data from a reference probability sample. Implement the Doubly-robust method using the <code>nonprob</code> function with the following specifications:</p>
<ol type="1">
<li><p>Set up an outcome model for <code>SMOKE100</code> that includes the variables <code>AGECAT</code>, <code>RACECAT</code>, <code>EDCAT</code>, and <code>INETHOME</code></p></li>
<li><p>Set up a selection model that includes the variables <code>AGECAT</code>, <code>RACECAT</code>, <code>EDCAT</code>, and <code>INETHOME</code></p></li>
<li><p>Use the probability sample design you created before as input for <code>svydesign</code></p></li>
<li><p>Given the outcome type, select the correct option for the <code>method_outcome</code> and <code>family_outcome</code></p></li>
<li><p>Use a logistic regression for the selection model</p></li>
<li><p>Save the estimate and the confidence interval</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-13-contents" aria-controls="callout-13" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-13" class="callout-13-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dr_logit_sample <span class="ot">&lt;-</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nonprob</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">selection =</span> <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> SMOKE100 <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> np_sample,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">svydesign =</span> ps_design,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_selection =</span> <span class="st">"logit"</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_outcome =</span> <span class="st">"glm"</span>,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family_outcome =</span> <span class="st">"binomial"</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(dr_logit_sample<span class="sc">$</span>output, dr_logit_sample<span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5263664 0.03303545   0.4616181   0.5911147</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> dr_logit_sample<span class="sc">$</span>output<span class="sc">$</span>mean,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_bound =</span> dr_logit_sample<span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_bound =</span> dr_logit_sample<span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"dr_logit_sample"</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate is 52.53% (CI: 46.2% - 59.1%).</p>
</section>
<section id="when-only-population-information-is-available-2" class="level3">
<h3 class="anchored" data-anchor-id="when-only-population-information-is-available-2"><strong>When only population information is available</strong></h3>
<p>Now we assume that only population totals are available.</p>
<ol type="1">
<li>Implement the Doubly-Robust approach again using the <code>nonprob</code> function with the previous specifications but instead of <code>svydesign</code> , specify the <code>pop_totals</code>.</li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dr_logit_poptotals  <span class="ot">&lt;-</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nonprob</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">selection =</span> <span class="sc">~</span>  AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> SMOKE100 <span class="sc">~</span> AGECAT <span class="sc">+</span> RACECAT <span class="sc">+</span> EDCAT <span class="sc">+</span> INETHOME,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> np_sample,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_totals =</span> pop_tot,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_selection =</span> <span class="st">"logit"</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_outcome =</span> <span class="st">"glm"</span>,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family_outcome =</span> <span class="st">"binomial"</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">#display</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(dr_logit_poptotals <span class="sc">$</span>output, dr_logit_poptotals <span class="sc">$</span>confidence_interval)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mean         SE lower_bound upper_bound
SMOKE100 0.5467979 0.02724855   0.4933917   0.6002041</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#save</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> compare <span class="sc">%&gt;%</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> dr_logit_poptotals <span class="sc">$</span>output<span class="sc">$</span>mean,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_bound =</span> dr_logit_poptotals <span class="sc">$</span>confidence_interval<span class="sc">$</span>lower_bound,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_bound =</span> dr_logit_poptotals <span class="sc">$</span>confidence_interval<span class="sc">$</span>upper_bound,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"dr_logit_poptotals"</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The estimate is 54.7% (CI: 49.3% - 60.0%).</p>
</section>
</section>
<section id="comparing-the-results" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-results"><strong>Comparing the results</strong></h2>
<p>Finally compare the estimates. Use can use <code>ggplot</code> to plot the data in the <code>compare</code> table.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>compare<span class="sc">$</span>method<span class="ot">=</span><span class="fu">factor</span>(compare<span class="sc">$</span>method, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"dr_logit_poptotals"</span>,<span class="st">"dr_logit_sample"</span>,<span class="st">"mi_pop_tot"</span>,<span class="st">"mi_sample"</span>,<span class="st">"ipw_pop_tot"</span>, <span class="st">"ipw_ps"</span>, <span class="st">"greg"</span>, <span class="st">"raking"</span>,<span class="st">"nps"</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>compare <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> method,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> estimate,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xmin =</span> lower_bound,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">xmax =</span> upper_bound</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>)) <span class="sc">+</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">xintercept =</span> <span class="fl">0.5285</span>,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dotted"</span>,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>() <span class="sc">+</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Point estimator and confidence interval"</span>, <span class="at">y =</span> <span class="st">"estimators"</span>)<span class="sc">+</span><span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Data_Int_nonprob_workshop_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Congratulations! 🎉
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve successfully completed these exercises! By now, you should have a solid understanding of how the different approaches work and how to apply various methodologies.</p>
<p>To keep building your skills, here are a few extra exercises:</p>
<ul>
<li><p><strong>Explore the outputs</strong>: Take some time to analyze the results from the different models, such as the weights, predictions, and more</p></li>
<li><p><strong>Try out different specifications</strong>: Use a different model than logistic regressioin</p></li>
<li><p><strong>Apply what you’ve learned</strong>: Try using these models on your own data to see how they perform in real-world scenarios</p></li>
</ul>
<p>Interested in survey statistics? Check it out these courses:</p>
<ul>
<li><a href="https://utrechtsummerschool.nl/"><strong>UU Summer Schools</strong></a>: Advanced Survey Design and Statistical Analysis and Estimation</li>
</ul>
</div>
</div>
</section>
</section>
<section id="bayesian-approaches" class="level1">
<h1><strong>Bayesian approaches</strong></h1>
<section id="multilevel-regression-and-post-stratification" class="level2">
<h2 class="anchored" data-anchor-id="multilevel-regression-and-post-stratification"><strong>Multilevel regression and post-stratification</strong></h2>
<p>We use the data from from the 2018 Cooperative Cooperative Congressional Election Study, a US nationwide survey designed by a consortium of 60 research teams and administered by YouGov. The data and the guide with information about the survey and the questionnaire area available <a href="hhttps://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/ZSBZ7K">here</a>.</p>
<p>This tutorial is adapted from the Book <strong>MRP Case Studies</strong> that you can find <a href="https://bookdown.org/jl5522/MRP-case-studies/introduction-to-mister-p.html">here</a>.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Estimate the proportion of individuals who support the cut in the Corporate Income Tax rate. The questionnaire item is the following:</li>
</ul>
<p><em>Congress considered many changes in tax law over the past two years. Do you support or oppose each of the following?</em></p>
<p><strong>CC18_325a</strong> <strong>Taxes</strong> – Cut the Corporate Income Tax rate from 39 percent to 21 percent. (Support/Oppose)</p>
<ul>
<li>Compare the estimates obtained with the unadjasted nonprobability sample, with the estimates we would obtain if we had a large probability sample and the estimates obtained with MRP</li>
</ul>
</div>
</div>
<section id="the-data-1" class="level3">
<h3 class="anchored" data-anchor-id="the-data-1"><strong>The data</strong></h3>
<p>The variables are the following:</p>
<ul>
<li><p><code>state</code> : 50 US states</p></li>
<li><p><code>age</code> : Age in classes, 18-29, 30-39, 40-49, 50-59, 60-69, 70+</p></li>
<li><p><code>male</code> : Gender classified as male (1) or Female (2)</p></li>
<li><p><code>eth</code> : Ethnicity classified as (Non-hispanic) White, Black, Hispanic, Other (which also includes Mixed)</p></li>
<li><p><code>educ</code> : Education classified as No HS, HS, Some college, 4-year college, Post-grad</p></li>
<li><p><code>region</code> : Geographical region classified in Northeast, North Central, South, and West</p></li>
<li><p><code>repvote</code> : Republican vote share in the 2016 presidential election</p></li>
</ul>
<p>If you follow the book example, some data pre-processing are needed. Here, for simplicity, we use a ready-to-use version of the data.</p>
<p>Before starting, you need to install and load the following packages:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalt)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You have the following dataset available:</p>
<ul>
<li><p><code>statelevel_predictors_df</code> : for each one of the 50 US States contains the <code>repvote</code> and the <code>region</code></p></li>
<li><p><code>cces_biased_df</code> : a nonprobability sample of size 5.000 from which we obtain un-adjusted estimates and then MRP estimates</p></li>
<li><p><code>cces_all_df</code> : is the full probability sample of size 59.693 observations that we use only for comparison</p></li>
<li><p><code>poststrat_df_full</code> : is the poststratification table with population counts constructed considering the state, the ethniticy, the gender, the age and the education of individuals. As we defined the levels for these variables, the poststratification table must have <span class="math inline">\(50 \cdot 6 \cdot 2 \cdot 4 \cdot 5 = 12.000\)</span> rows. This means we actually have more rows in the poststratification table than observed units, which necessarily implies that there are some combinations in the poststratification table that we don’t observe in our nonprobability sample. In this example, we ensured that all cells in the poststratification table were included, even if their weight was zero, but this was done solely for illustrative purposes.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>statelevel_predictors_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'statelevel_predictors.csv'</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"cces_all_df.rda"</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"cces_biased_df.rda"</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"poststrat_df_full.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preliminary-analyses-1" class="level3">
<h3 class="anchored" data-anchor-id="preliminary-analyses-1"><strong>Preliminary analyses</strong></h3>
<ol type="1">
<li>Compare the composition of the nonprobability sample with respect to the population characteristics (in the poststratification table)</li>
</ol>
<p>One of the possible solutions follows.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggalt)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forcats)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate sample and population proportions</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>calculate_proportions <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_df, poststrat_df, group_var) {</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  sample_prop <span class="ot">&lt;-</span> sample_df <span class="sc">%&gt;%</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>({{ group_var }}) <span class="sc">%&gt;%</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Sample =</span> <span class="fu">n</span>() <span class="sc">/</span> <span class="fu">nrow</span>(sample_df))</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  pop_prop <span class="ot">&lt;-</span> poststrat_df <span class="sc">%&gt;%</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>({{ group_var }}) <span class="sc">%&gt;%</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">Population =</span> <span class="fu">sum</span>(n) <span class="sc">/</span> <span class="fu">sum</span>(poststrat_df<span class="sc">$</span>n))</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(sample_prop, pop_prop, <span class="at">by =</span> <span class="fu">as.character</span>(<span class="fu">substitute</span>(group_var)))</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create dumbbell plots</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>create_dumbbell_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(data, group_var, x_limits, title, <span class="at">x_label =</span> <span class="st">"Proportion"</span>) {</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(data) <span class="sc">+</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_dumbbell</span>(<span class="fu">aes</span>(<span class="at">y =</span> {{ group_var }}, <span class="at">x =</span> Sample, <span class="at">xend =</span> Population)) <span class="sc">+</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">melt</span>(data, <span class="at">id.vars =</span> <span class="fu">as.character</span>(<span class="fu">substitute</span>(group_var))),</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">y =</span> {{ group_var }}, <span class="at">x =</span> value, <span class="at">color =</span> variable),</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> x_limits) <span class="sc">+</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> title, <span class="at">x =</span> x_label, <span class="at">y =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"#E37B1C"</span>, <span class="st">"#1CE37B"</span>))</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Age Plot</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>age <span class="ot">&lt;-</span> <span class="fu">calculate_proportions</span>(cces_biased_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">age =</span> <span class="fu">factor</span>(age)), poststrat_df, age)</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>age_plot <span class="ot">&lt;-</span> <span class="fu">create_dumbbell_plot</span>(age, age, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.35</span>), <span class="st">"Age"</span>, <span class="st">"Proportion"</span>)</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Gender Plot</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>gender <span class="ot">&lt;-</span> <span class="fu">calculate_proportions</span>(cces_biased_df, poststrat_df, male) <span class="sc">%&gt;%</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">male =</span> <span class="fu">factor</span>(male, <span class="at">levels =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>)))</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>gender_plot <span class="ot">&lt;-</span> <span class="fu">create_dumbbell_plot</span>(gender, male, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.6</span>), <span class="st">"Gender"</span>)</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Ethnicity Plot</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>ethnicity <span class="ot">&lt;-</span> <span class="fu">calculate_proportions</span>(cces_biased_df, poststrat_df, eth)</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>ethnicity_plot <span class="ot">&lt;-</span> <span class="fu">create_dumbbell_plot</span>(ethnicity, eth, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.9</span>), <span class="st">"Ethnicity"</span>)</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Education Plot</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>education <span class="ot">&lt;-</span> <span class="fu">calculate_proportions</span>(cces_biased_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">educ =</span> <span class="fu">factor</span>(educ)), poststrat_df, educ)</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>education_plot <span class="ot">&lt;-</span> <span class="fu">create_dumbbell_plot</span>(education, educ, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.33</span>), <span class="st">"Education"</span>)</span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a><span class="co"># State Plot</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>state <span class="ot">&lt;-</span> <span class="fu">calculate_proportions</span>(cces_biased_df, poststrat_df, state)</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>state_plot <span class="ot">&lt;-</span> <span class="fu">create_dumbbell_plot</span>(state, state, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.33</span>), <span class="st">"State"</span>)<span class="sc">+</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>)</span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Display all plots</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(age_plot, gender_plot, ethnicity_plot, </span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>                  education_plot, <span class="at">nrow=</span><span class="dv">2</span>,<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">common.legend =</span> <span class="cn">TRUE</span>, <span class="at">legend=</span><span class="st">"bottom"</span>)</span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>state_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="fig1_1.png" class="img-fluid" width="680"></p>
</div>
<div class="cell-output-display">
<p><img src="fig2_1.png" class="img-fluid" width="662"></p>
</div>
</div>
</div>
</div>
</div>
<p>We can see that in the nonprobability samples individuals tends to be older, male, white, less educated and from Republican states.</p>
</section>
<section id="the-mister-mr" class="level3">
<h3 class="anchored" data-anchor-id="the-mister-mr"><strong>The Mister: MR</strong></h3>
<ol type="1">
<li><p>In this section you need to implement a multilevel regression in order to predict the outcome (<code>taxred</code>) based on a set of factors.</p></li>
<li><p>Use the <code>stn_gmler</code> function.</p></li>
<li><p>Include in the model varying intercepts <code>(1 | x)</code> for: <code>age</code>, <code>eth</code>, <code>educ</code>, and <code>state</code></p></li>
<li><p>Include interactions <code>(1 | x1:x2)</code> between <code>male</code> and <code>eth</code> , <code>educ</code> and <code>age</code> and <code>educ</code> and <code>eth</code></p></li>
<li><p>Include as state-level predictors also <code>repvote</code> and <code>region</code></p></li>
<li><p>Use a logistic model</p></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solulion
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan_glmer</span>(taxred <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> state) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> eth) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> educ) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> age) <span class="sc">+</span> male <span class="sc">+</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                    (<span class="dv">1</span> <span class="sc">|</span> male<span class="sc">:</span>eth) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> educ<span class="sc">:</span>age) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> educ<span class="sc">:</span>eth) <span class="sc">+</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                    repvote <span class="sc">+</span> <span class="fu">factor</span>(region),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>),</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> cces_biased_df,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prior_covariance =</span> <span class="fu">decov</span>(<span class="at">scale =</span> <span class="fl">0.50</span>),</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">seed =</span> <span class="dv">1010</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Running this code might be computational expensive, thus you can directly load the data with the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"my_fit.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-p-postststratification" class="level3">
<h3 class="anchored" data-anchor-id="the-p-postststratification"><strong>The P: Postststratification</strong></h3>
<p>The second step is to poststratify, but first we use our model to get an estimate for each row of the post-stratification table. Then, poststratification is implemented by weighting the estimate by the proportion of individual in that poststratification cell.</p>
<p>Thus, we first compute the proportion for each cell of the postratificaiton table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>poststrat_df <span class="ot">&lt;-</span>poststrat_df <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop=</span>n<span class="sc">/</span><span class="fu">sum</span>(n),<span class="at">.by=</span>state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code shows how to:</p>
<ol type="1">
<li><p><strong>Generate predictions using the Bayesian Model:</strong></p>
<p>The first part of the code involves generating predictions for the poststratification data based on the Bayesian model we’ve estimated. This process uses the add_epred_draws() function to draw 4000 samples from the posterior predictive distribution.</p></li>
<li><p><strong>Compute the MRP estimates:</strong> The procedure involves the following steps:</p></li>
</ol>
<ul>
<li><strong><em>Compute the Weighted Average Prediction:</em></strong> To obtain the MRP estimates, remember the formula in the slides: <code>pred * n/N</code>, where <code>pred</code> represents the predicted preference value, <code>n</code> is the number of people in each poststratification cell, and <code>N</code> is the total population size. This formula adjusts the predictions according to the size of each poststratification cell, giving a weighted average.</li>
<li><strong><em>Summarize Predictions by State:</em></strong> For each state, aggregate the weighted predictions from all poststratification cells within that state. At this stage, you will have 4000 weighted predictions for each state.</li>
<li><strong><em>Average the Predictions across the 4000 draws:</em></strong> Since we have 4000 draws, we compute the average prediction. To quantify the uncertainty, we calculate the 2.5th and 97.5th percentiles of the predictions, which form the lower and upper bounds of the 95% credibility interval, respectively.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidybayes' was built under R version 4.3.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mrp_estimates <span class="ot">=</span> fit <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_epred_draws</span>(<span class="at">newdata =</span> poststrat_df, <span class="at">ndraws =</span> <span class="dv">4000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rename</span>(<span class="at">pred =</span> .epred)  <span class="sc">%&gt;%</span> </span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ps_pred =</span> pred <span class="sc">*</span> prop) <span class="sc">%&gt;%</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pred =</span> <span class="fu">sum</span>(ps_pred),</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> <span class="fu">c</span>(state, .draw)) <span class="sc">%&gt;%</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> <span class="fu">mean</span>(pred),</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_ci =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.025</span>),</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_ci =</span> <span class="fu">quantile</span>(pred, <span class="fl">0.975</span>),</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> state</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<ol start="3" type="1">
<li><strong>We want to compare</strong> the MRP estimates with those derived from an unadjusted nonprobability sample and with estimates from a large probability sample. To accomplish this, you can use the following code. Remember that:</li>
</ol>
<ul>
<li>To compute the confidence interval, you first need to determine the standard deviation of the variable (Bernoulli).</li>
<li>The confidence interval is then computed as the estimate plus or minus 2 times the standard dev. This is because, under the assumption of a normal distribution, approximately 95% of the data lies within 2 standard deviations of the mean.</li>
</ul>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate the standard error for a Bernoulli distribution</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>get_se_bernoulli <span class="ot">&lt;-</span> <span class="cf">function</span>(p, n) {</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(p <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> p) <span class="sc">/</span> n)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the states</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>state_abb <span class="ot">&lt;-</span> datasets<span class="sc">::</span>state.abb</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate estimates and confidence intervals for a given dataset</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>calculate_estimates <span class="ot">&lt;-</span> <span class="cf">function</span>(data, state_abb) {</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">%in%</span> state_abb) <span class="sc">%&gt;%</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">estimate =</span> <span class="fu">mean</span>(taxred, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_sample =</span> <span class="fu">n</span>(),</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">se =</span> <span class="fu">get_se_bernoulli</span>(estimate, n_sample),</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower_ci =</span> estimate <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> se,</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper_ci =</span> estimate <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> se</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate estimates and confidence intervals for both datasets</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>biased_estimates <span class="ot">&lt;-</span> <span class="fu">calculate_estimates</span>(cces_biased_df, state_abb)</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>full_estimates <span class="ot">&lt;-</span> <span class="fu">calculate_estimates</span>(cces_all_df, state_abb)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the results into one dataset (in wide format)</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>states_df <span class="ot">&lt;-</span> biased_estimates <span class="sc">%&gt;%</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"biased_"</span>, .), <span class="sc">-</span>state) <span class="sc">%&gt;%</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(full_estimates <span class="sc">%&gt;%</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"full_"</span>, .), <span class="sc">-</span>state), <span class="at">by =</span> <span class="st">"state"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mrp_estimates<span class="sc">%&gt;%</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"mrp_"</span>, .), <span class="sc">-</span>state), <span class="at">by =</span> <span class="st">"state"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="compare-the-results" class="level3">
<h3 class="anchored" data-anchor-id="compare-the-results"><strong>Compare the results</strong></h3>
<ol type="1">
<li>Compare the results using <code>ggplot</code></li>
</ol>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Click here to show the solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the comparison using ggplot</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(states_df) <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">y =</span> biased_estimate, <span class="at">color =</span> <span class="st">"Unadj. NPS"</span>)) <span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">ymin =</span> biased_lower_ci, <span class="at">ymax =</span> biased_upper_ci, <span class="at">color =</span> <span class="st">"Unadj. NPS"</span>), <span class="at">width =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">y =</span> full_estimate, <span class="at">color =</span> <span class="st">"Large PS"</span>)) <span class="sc">+</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">ymin =</span> full_lower_ci, <span class="at">ymax =</span> full_upper_ci, <span class="at">color =</span> <span class="st">"Large PS"</span>), <span class="at">width =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">y =</span> mrp_estimate, <span class="at">color =</span> <span class="st">"NPS with MRP"</span>)) <span class="sc">+</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">x =</span> state, <span class="at">ymin =</span> mrp_lower_ci, <span class="at">ymax =</span> mrp_upper_ci, <span class="at">color =</span> <span class="st">"NPS with MRP"</span>), <span class="at">width =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Estimates and Confidence Intervals by State"</span>,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"State"</span>,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Estimate and 95% CI"</span>,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Sample Type"</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Unadj. NPS"</span> <span class="ot">=</span> <span class="st">"#E37B1C"</span>, <span class="st">"NPS with MRP"</span> <span class="ot">=</span> <span class="st">"#7B1CE3"</span>, <span class="st">"Large PS"</span> <span class="ot">=</span> <span class="st">"#1CE37B"</span>)) <span class="sc">+</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="fig3_1.png" class="img-fluid" width="680"></p>
</div>
</div>
</div>
</div>
</div>
<div class="callout-tip callout callout-style-default no-icon callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Congratulations! 🎉
</div>
</div>
<div class="callout-body-container callout-body">
<p>You’ve made it through these exercises! By now, you should have a solid understanding of how MRP works—or at least a pretty good idea.</p>
<p>Bayesian inference can be a bit tricky, but don’t worry if it feels like a lot to take in. You’re on the right track!</p>
<p>To improve your Bayesian skills, here are some excellent resources:</p>
<ul>
<li><p><a href="https://sites.google.com/site/doingbayesiandataanalysis/"><strong>Doing Bayesian Data Analysis</strong></a>: by John K. Kruschke</p></li>
<li><p><a href="https://avehtari.github.io/ROS-Examples/"><strong>Regression and Other stories</strong></a>: by Andrew Gelman, Jennifer Hill, and Aki Vehtari</p></li>
</ul>
</div>
</div>
</section>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>Some of the exercises are adapted from:</p>
<ul>
<li><p>Valliant, R., Dever, J. A., &amp; Kreuter, F. (2018). <em>Practical tools for designing and weighting survey samples</em> (Vol. 1). New York: Springer.</p></li>
<li><p>The <strong>MRP Case Studies online book</strong> that you can find <a href="https://bookdown.org/jl5522/MRP-case-studies/introduction-to-mister-p.html">here</a>.</p></li>
</ul>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>